<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mapping between Embeddings • BIRSBIO2020.scProteomics.embeddings</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Mapping between Embeddings">
<meta property="og:description" content="BIRSBIO2020.scProteomics.embeddings">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-93043521-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-93043521-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">BIRSBIO2020.scProteomics.embeddings</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/composition.html">Disentangling Composition and Spatial Effects</a>
    </li>
    <li>
      <a href="../articles/derived_statistics.html">Features from MIBI Segmentations</a>
    </li>
    <li>
      <a href="../articles/embedding_prediction.html">Mapping between Embeddings</a>
    </li>
    <li>
      <a href="../articles/interactive.html">Interactive Visualization using Linked Views</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/seandavi/BuildABiocWorkshop2020">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="embedding_prediction_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Mapping between Embeddings</h1>
                        <h4 class="author">Kris Sankaran<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>
</h4>
            
      
      
      <div class="hidden name"><code>embedding_prediction.Rmd</code></div>

    </div>

    
    
<ul>
<li>In <code>composition.rmd</code> we ask whether it’s possible to recover sample-level spatial features from protein expression measurements</li>
<li>We ask a more challenging question here, looking for whether it’s possible to identify spatial features associated with individual cells, just from the expression measurements</li>
<li>Understandably more far fetched, but there are some reasons it could happen – maybe when an immune cell is surrounded by cancer cells, it has a different protein expression pattern than when it is surrounded by other immune cells</li>
<li>Again, motivation is that spatial characteristics of cells are interesting, but it’s easier to use technologies that only interrogate expression information</li>
</ul>
<p>One theme between this vignette and <code>composition.Rmd</code> is that the notion of a sampling unit is not so straightforwards in this analysis – we can reasonably analyze the data at several levels of resolution. This vignette considers the cell-resolution analog of the sample-level questions in that vignette.</p>
<p>Without further delay, these are the packages we use in this analysis.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"SummarizedExperiment"</span>)</pre></body></html></div>
<pre><code>## Loading required package: GenomicRanges</code></pre>
<pre><code>## Loading required package: stats4</code></pre>
<pre><code>## Loading required package: BiocGenerics</code></pre>
<pre><code>## Loading required package: parallel</code></pre>
<pre><code>## 
## Attaching package: 'BiocGenerics'</code></pre>
<pre><code>## The following objects are masked from 'package:parallel':
## 
##     clusterApply, clusterApplyLB, clusterCall, clusterEvalQ,
##     clusterExport, clusterMap, parApply, parCapply, parLapply,
##     parLapplyLB, parRapply, parSapply, parSapplyLB</code></pre>
<pre><code>## The following objects are masked from 'package:stats':
## 
##     IQR, mad, sd, var, xtabs</code></pre>
<pre><code>## The following objects are masked from 'package:base':
## 
##     anyDuplicated, append, as.data.frame, basename, cbind, colnames,
##     dirname, do.call, duplicated, eval, evalq, Filter, Find, get, grep,
##     grepl, intersect, is.unsorted, lapply, Map, mapply, match, mget,
##     order, paste, pmax, pmax.int, pmin, pmin.int, Position, rank,
##     rbind, Reduce, rownames, sapply, setdiff, sort, table, tapply,
##     union, unique, unsplit, which.max, which.min</code></pre>
<pre><code>## Loading required package: S4Vectors</code></pre>
<pre><code>## 
## Attaching package: 'S4Vectors'</code></pre>
<pre><code>## The following object is masked from 'package:base':
## 
##     expand.grid</code></pre>
<pre><code>## Loading required package: IRanges</code></pre>
<pre><code>## Loading required package: GenomeInfoDb</code></pre>
<pre><code>## Loading required package: Biobase</code></pre>
<pre><code>## Welcome to Bioconductor
## 
##     Vignettes contain introductory material; view with
##     'browseVignettes()'. To cite Bioconductor, see
##     'citation("Biobase")', and for packages 'citation("pkgname")'.</code></pre>
<pre><code>## Loading required package: DelayedArray</code></pre>
<pre><code>## Loading required package: Matrix</code></pre>
<pre><code>## 
## Attaching package: 'Matrix'</code></pre>
<pre><code>## The following object is masked from 'package:S4Vectors':
## 
##     expand</code></pre>
<pre><code>## Loading required package: matrixStats</code></pre>
<pre><code>## 
## Attaching package: 'matrixStats'</code></pre>
<pre><code>## The following objects are masked from 'package:Biobase':
## 
##     anyMissing, rowMedians</code></pre>
<pre><code>## 
## Attaching package: 'DelayedArray'</code></pre>
<pre><code>## The following objects are masked from 'package:matrixStats':
## 
##     colMaxs, colMins, colRanges, rowMaxs, rowMins, rowRanges</code></pre>
<pre><code>## The following objects are masked from 'package:base':
## 
##     aperm, apply, rowsum</code></pre>
<div class="sourceCode" id="cb27"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"dplyr"</span>)</pre></body></html></div>
<pre><code>## 
## Attaching package: 'dplyr'</code></pre>
<pre><code>## The following object is masked from 'package:matrixStats':
## 
##     count</code></pre>
<pre><code>## The following object is masked from 'package:Biobase':
## 
##     combine</code></pre>
<pre><code>## The following objects are masked from 'package:GenomicRanges':
## 
##     intersect, setdiff, union</code></pre>
<pre><code>## The following object is masked from 'package:GenomeInfoDb':
## 
##     intersect</code></pre>
<pre><code>## The following objects are masked from 'package:IRanges':
## 
##     collapse, desc, intersect, setdiff, slice, union</code></pre>
<pre><code>## The following objects are masked from 'package:S4Vectors':
## 
##     first, intersect, rename, setdiff, setequal, union</code></pre>
<pre><code>## The following objects are masked from 'package:BiocGenerics':
## 
##     combine, intersect, setdiff, union</code></pre>
<pre><code>## The following objects are masked from 'package:stats':
## 
##     filter, lag</code></pre>
<pre><code>## The following objects are masked from 'package:base':
## 
##     intersect, setdiff, setequal, union</code></pre>
<div class="sourceCode" id="cb38"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"forcats"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"ggplot2"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"keras"</span>)</pre></body></html></div>
<pre><code>## 
## Attaching package: 'keras'</code></pre>
<pre><code>## The following object is masked from 'package:BiocGenerics':
## 
##     normalize</code></pre>
<div class="sourceCode" id="cb41"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"raster"</span>)</pre></body></html></div>
<pre><code>## Loading required package: sp</code></pre>
<pre><code>## 
## Attaching package: 'sp'</code></pre>
<pre><code>## The following object is masked from 'package:IRanges':
## 
##     %over%</code></pre>
<pre><code>## 
## Attaching package: 'raster'</code></pre>
<pre><code>## The following object is masked from 'package:dplyr':
## 
##     select</code></pre>
<pre><code>## The following objects are masked from 'package:SummarizedExperiment':
## 
##     distance, metadata&lt;-, shift, trim, values, values&lt;-</code></pre>
<pre><code>## The following objects are masked from 'package:GenomicRanges':
## 
##     distance, shift, trim, values, values&lt;-</code></pre>
<pre><code>## The following objects are masked from 'package:IRanges':
## 
##     distance, shift, trim, values, values&lt;-</code></pre>
<pre><code>## The following objects are masked from 'package:S4Vectors':
## 
##     metadata, metadata&lt;-, values, values&lt;-</code></pre>
<div class="sourceCode" id="cb51"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"reshape2"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"stars"</span>)</pre></body></html></div>
<pre><code>## Loading required package: abind</code></pre>
<pre><code>## Loading required package: sf</code></pre>
<pre><code>## Linking to GEOS 3.6.2, GDAL 2.2.3, PROJ 4.9.3</code></pre>
<div class="sourceCode" id="cb55"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"stringr"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"tibble"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"tidyr"</span>)</pre></body></html></div>
<pre><code>## 
## Attaching package: 'tidyr'</code></pre>
<pre><code>## The following object is masked from 'package:reshape2':
## 
##     smiths</code></pre>
<pre><code>## The following object is masked from 'package:raster':
## 
##     extract</code></pre>
<pre><code>## The following objects are masked from 'package:Matrix':
## 
##     expand, pack, unpack</code></pre>
<pre><code>## The following object is masked from 'package:S4Vectors':
## 
##     expand</code></pre>
<div class="sourceCode" id="cb61"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"umap"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"viridis"</span>)</pre></body></html></div>
<pre><code>## Loading required package: viridisLite</code></pre>
<div class="sourceCode" id="cb63"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"BIRSBIO2020.scProteomics.embeddings"</span>)
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>() + <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">panel.grid</span><span class="kw">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span>()))</pre></body></html></div>
<p>We download the data if it’s not already present. We’re filtering to just 10 samples in this run, since it lets the vignette run faster. But to train the complete model, replace the <code>params$max_sample</code> with 41 (the number of raster files we have).</p>
<div class="sourceCode" id="cb64"><html><body><pre class="r"><span class="no">data_dir</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span>(<span class="st">"HOME"</span>), <span class="st">"Data"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/get.html">get</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">data_dir</span>, <span class="st">"mibiSCE.rda"</span>)))</pre></body></html></div>
<pre><code>## class: SingleCellExperiment 
## dim: 49 201656 
## metadata(0):
## assays(1): mibi_exprs
## rownames(49): C Na ... Ta Au
## rowData names(4): channel_name is_protein hgnc_symbol wagner_overlap
## colnames: NULL
## colData names(36): SampleID cellLabelInImage ...
##   Survival_days_capped_2016.1.1 Censored
## reducedDimNames(0):
## altExpNames(0):</code></pre>
<div class="sourceCode" id="cb66"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/BIRSBIO2020.scProteomics.embeddings/man/download_data.html">download_data</a></span>(<span class="no">data_dir</span>)</pre></body></html></div>
<pre><code>## Warning in dir.create(directory, recursive = TRUE): '/github/home/Data' already
## exists</code></pre>
<pre><code>## [[1]]
## [1] "/github/home/Data/mibiSCE.rda"
## 
## [[2]]
## [1] "/github/home/Data/masstagSCE.rda"
## 
## [[3]]
## [1] "/github/home/Data/TNBC_shareCellData"</code></pre>
<div class="sourceCode" id="cb69"><html><body><pre class="r"><span class="no">loaded_</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BIRSBIO2020.scProteomics.embeddings/man/load_mibi.html">load_mibi</a></span>(<span class="no">data_dir</span>, <span class="no">params</span>$<span class="no">max_samples</span>)</pre></body></html></div>
<p>We’ll loop over all the tiffs and extract the 100 <span class="math inline">\(\times\)</span> 100 top-left quadrant from each image, also to speed up computation in these experiments.</p>
<div class="sourceCode" id="cb70"><html><body><pre class="r"><span class="no">subsample</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BIRSBIO2020.scProteomics.embeddings/man/spatial_subsample.html">spatial_subsample</a></span>(<span class="no">loaded_</span>$<span class="no">tiffs</span>, <span class="no">loaded_</span>$<span class="no">mibi</span>)</pre></body></html></div>
<pre><code>## [1] "cropping 1/10"
## [1] "cropping 2/10"
## [1] "cropping 3/10"
## [1] "cropping 4/10"
## [1] "cropping 5/10"
## [1] "cropping 6/10"
## [1] "cropping 7/10"
## [1] "cropping 8/10"
## [1] "cropping 9/10"
## [1] "cropping 10/10"</code></pre>
<div class="sourceCode" id="cb72"><html><body><pre class="r"><span class="no">ims</span> <span class="kw">&lt;-</span> <span class="no">subsample</span>$<span class="no">ims</span>
<span class="no">mibi_sce</span> <span class="kw">&lt;-</span> <span class="no">subsample</span>$<span class="no">exper</span></pre></body></html></div>
<p>Now, let’s extract some features on which to perform the joint embedding. We’ll transform and reweight the columns, to make the two sets of features more comparable. First, for transformation, we’ll convert antigen expression values to ranks and then threshold.</p>
<div class="sourceCode" id="cb73"><html><body><pre class="r"><span class="no">x</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/transpose.html">t</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html">assay</a></span>(<span class="no">mibi_sce</span>))
<span class="no">x_order</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/hclust.html">hclust</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/dist.html">dist</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/raster/man/transpose.html">t</a></span>(<span class="no">x</span>)))$<span class="no">order</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/pairs.html">pairs</a></span>(<span class="no">x</span>[, <span class="no">x_order</span>[<span class="fl">1</span>:<span class="fl">6</span>]], <span class="kw">col</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html">rgb</a></span>(<span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0.5</span>), <span class="kw">cex</span><span class="kw">=</span><span class="fl">0.1</span>)</pre></body></html></div>
<p><img src="embedding_prediction_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<p>Next, we’ll extract some features from the spatial data. Note that some cells seem to appear in the raster but not in the <code>colData</code>. This seems weird, and is worth looking into, but for now I’m going to just innerJoin to ignore that.</p>
<div class="sourceCode" id="cb74"><html><body><pre class="r"><span class="co"># polygonize each raster</span>
<span class="no">col_df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.data.frame.html">as.data.frame</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html">colData</a></span>(<span class="no">mibi_sce</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(
    <span class="kw">cell_type</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BIRSBIO2020.scProteomics.embeddings/man/cell_type.html">cell_type</a></span>(<span class="no">mibi_sce</span>),
    <span class="kw">cell_group</span> <span class="kw">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_lump.html">fct_lump</a></span>(<span class="no">cell_type</span>, <span class="kw">prop</span> <span class="kw">=</span> <span class="fl">0.05</span>),
  )

<span class="no">polys</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>()
<span class="kw">for</span> (<span class="no">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span>(<span class="no">ims</span>)) {
  <span class="no">cur_sample</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html">names</a></span>(<span class="no">ims</span>)[<span class="no">i</span>]
  <span class="no">cur_cols</span> <span class="kw">&lt;-</span> <span class="no">col_df</span> <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">SampleID</span> <span class="kw">%in%</span> <span class="no">cur_sample</span>)
  <span class="no">polys</span><span class="kw">[[</span><span class="no">i</span>]] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BIRSBIO2020.scProteomics.embeddings/man/polygonize.html">polygonize</a></span>(<span class="no">ims</span><span class="kw">[[</span><span class="no">i</span>]]) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">SampleID</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">cur_sample</span>)) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unite.html">unite</a></span>(<span class="no">sample_by_cell</span>, <span class="no">SampleID</span>, <span class="no">cellLabelInImage</span>, <span class="kw">remove</span><span class="kw">=</span><span class="fl">FALSE</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span>(<span class="no">cur_cols</span>, <span class="kw">by</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"SampleID"</span>, <span class="st">"cellLabelInImage"</span>))
}

<span class="no">polys</span> <span class="kw">&lt;-</span> <span class="no">polys</span>[<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">polys</span>, <span class="no">nrow</span>) <span class="kw">&gt;</span> <span class="fl">0</span>]
<span class="no">col_df</span> <span class="kw">&lt;-</span> <span class="no">col_df</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unite.html">unite</a></span>(<span class="no">sample_by_cell</span>, <span class="no">SampleID</span>, <span class="no">cellLabelInImage</span>, <span class="kw">remove</span><span class="kw">=</span><span class="fl">FALSE</span>)

<span class="co"># a little plot</span>
<span class="no">polys_df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span>(<span class="no">rbind</span>, <span class="no">polys</span>)
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">polys_df</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(!<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">cellSize</span>))) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">fill</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/factor.html">as.factor</a></span>(<span class="no">tumorYN</span>))) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(<span class="no">Survival_days_capped_2016.1.1</span>~<span class="no">SampleID</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"bottom"</span>)</pre></body></html></div>
<p><img src="embedding_prediction_files/figure-html/graph_stats-1.png" width="700"></p>
<div class="sourceCode" id="cb75"><html><body><pre class="r"><span class="co"># some features that don't need graph construction</span>
<span class="no">cell_stats</span> <span class="kw">&lt;-</span> <span class="no">polys_df</span> <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">sample_by_cell</span>, <span class="no">cell_type</span>, <span class="no">cellSize</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(
    <span class="kw">log_size</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="no">cellSize</span>),
    <span class="kw">value</span> <span class="kw">=</span> <span class="fl">1</span>
  ) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/spread.html">spread</a></span>(<span class="no">cell_type</span>, <span class="no">value</span>, <span class="fl">0</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.data.frame.html">as.data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(-<span class="no">cellSize</span>, -<span class="no">geometry</span>)

<span class="co"># extract basic graph features</span>
<span class="no">graph_stats</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>()
<span class="kw">for</span> (<span class="no">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span>(<span class="no">polys</span>)) {
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"processing sample "</span>, <span class="no">i</span>, <span class="st">"/"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">polys</span>)))
  <span class="no">cell_ids</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/unique.html">unique</a></span>(<span class="no">polys</span><span class="kw">[[</span><span class="no">i</span>]]$<span class="no">cellLabelInImage</span>)
  <span class="no">G</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BIRSBIO2020.scProteomics.embeddings/man/extract_graph.html">extract_graph</a></span>(<span class="no">polys</span><span class="kw">[[</span><span class="no">i</span>]])
  <span class="no">graph_stats</span><span class="kw">[[</span><span class="no">i</span>]] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BIRSBIO2020.scProteomics.embeddings/man/loop_stats.html">loop_stats</a></span>(<span class="no">cell_ids</span>, <span class="st">"graph"</span>, <span class="no">G</span>, <span class="no">polys</span><span class="kw">[[</span><span class="no">i</span>]], <span class="no">type_props</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">cellType</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"graph_neighbors_"</span>, <span class="no">cellType</span>)) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/spread.html">spread</a></span>(<span class="no">cellType</span>, <span class="no">props</span>, <span class="fl">0</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">SampleID</span> <span class="kw">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nth.html">first</a></span>(<span class="no">polys</span><span class="kw">[[</span><span class="no">i</span>]]$<span class="no">SampleID</span>))
}</pre></body></html></div>
<pre><code>## [1] "processing sample 1/10"</code></pre>
<pre><code>## Warning in st_centroid.sf(geometries): st_centroid assumes attributes are
## constant over geometries of x</code></pre>
<pre><code>## [1] "processing sample 2/10"</code></pre>
<pre><code>## Warning in st_centroid.sf(geometries): st_centroid assumes attributes are
## constant over geometries of x</code></pre>
<pre><code>## [1] "processing sample 3/10"</code></pre>
<pre><code>## Warning in st_centroid.sf(geometries): st_centroid assumes attributes are
## constant over geometries of x</code></pre>
<pre><code>## [1] "processing sample 4/10"</code></pre>
<pre><code>## Warning in st_centroid.sf(geometries): st_centroid assumes attributes are
## constant over geometries of x</code></pre>
<pre><code>## [1] "processing sample 5/10"</code></pre>
<pre><code>## Warning in st_centroid.sf(geometries): st_centroid assumes attributes are
## constant over geometries of x</code></pre>
<pre><code>## [1] "processing sample 6/10"</code></pre>
<pre><code>## Warning in st_centroid.sf(geometries): st_centroid assumes attributes are
## constant over geometries of x</code></pre>
<pre><code>## [1] "processing sample 7/10"</code></pre>
<pre><code>## Warning in st_centroid.sf(geometries): st_centroid assumes attributes are
## constant over geometries of x</code></pre>
<pre><code>## [1] "processing sample 8/10"</code></pre>
<pre><code>## Warning in st_centroid.sf(geometries): st_centroid assumes attributes are
## constant over geometries of x</code></pre>
<pre><code>## [1] "processing sample 9/10"</code></pre>
<pre><code>## Warning in st_centroid.sf(geometries): st_centroid assumes attributes are
## constant over geometries of x</code></pre>
<pre><code>## [1] "processing sample 10/10"</code></pre>
<pre><code>## Warning in st_centroid.sf(geometries): st_centroid assumes attributes are
## constant over geometries of x</code></pre>
<div class="sourceCode" id="cb96"><html><body><pre class="r"><span class="no">graph_stats</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span>(<span class="no">graph_stats</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_all</a></span>(<span class="no">replace_na</span>, <span class="fl">0</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unite.html">unite</a></span>(<span class="no">sample_by_cell</span>, <span class="no">SampleID</span>, <span class="no">cellLabelInImage</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.data.frame.html">as.data.frame</a></span>(<span class="no">cell_stats</span>))</pre></body></html></div>
<pre><code>## Joining, by = "sample_by_cell"</code></pre>
<div class="sourceCode" id="cb98"><html><body><pre class="r"><span class="co"># example plot: what are the neighborhoods of tumors?</span>
<span class="fu"><a href="https://rdrr.io/pkg/stars/man/plot.html">plot</a></span>(<span class="no">graph_stats</span>$<span class="no">`Keratin-positive tumor`</span>, <span class="no">graph_stats</span>$<span class="no">`graph_neighbors_Keratin-positive tumor`</span>)</pre></body></html></div>
<p><img src="embedding_prediction_files/figure-html/graph_stats-2.png" width="700"></p>
<p>Now, we’ll standardize these features and learn some embeddings.</p>
<div class="sourceCode" id="cb99"><html><body><pre class="r"><span class="co"># standardize features between the two tables</span>
<span class="no">x</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/transpose.html">t</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html">assay</a></span>(<span class="no">mibi_sce</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span>()

<span class="no">x</span> <span class="kw">&lt;-</span> <span class="no">x</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_all</a></span>( <span class="kw">function</span>(<span class="no">u</span>) (<span class="no">u</span> - <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">u</span>)) / <span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span>(<span class="no">u</span>))) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_all</a></span>(<span class="kw">function</span>(<span class="no">u</span>) <span class="no">u</span> / <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/raster/man/ncell.html">ncol</a></span>(<span class="no">x</span>))) <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select_all.html">select_if</a></span>(<span class="kw">function</span>(<span class="no">u</span>) !<span class="fu"><a href="https://rdrr.io/r/base/all.html">all</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">u</span>))) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">sample_by_cell</span> <span class="kw">=</span> <span class="no">col_df</span>$<span class="no">sample_by_cell</span>)

<span class="no">y</span> <span class="kw">&lt;-</span> <span class="no">graph_stats</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_at</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span>(-<span class="no">sample_by_cell</span>), <span class="kw">function</span>(<span class="no">u</span>) (<span class="no">u</span> - <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">u</span>)) / <span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span>(<span class="no">u</span>))) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_at</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span>(-<span class="no">sample_by_cell</span>), <span class="kw">function</span>(<span class="no">u</span>) <span class="no">u</span> / <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/raster/man/ncell.html">ncol</a></span>(<span class="no">graph_stats</span>) - <span class="fl">1</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select_all.html">select_if</a></span>(<span class="kw">function</span>(<span class="no">u</span>) !<span class="fu"><a href="https://rdrr.io/r/base/all.html">all</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">u</span>)))

<span class="no">z</span> <span class="kw">&lt;-</span> <span class="no">x</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span>(<span class="no">y</span>, <span class="kw">by</span> <span class="kw">=</span> <span class="st">"sample_by_cell"</span>)
<span class="no">z_mat</span> <span class="kw">&lt;-</span> <span class="no">z</span> <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(-<span class="no">sample_by_cell</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.matrix.html">as.matrix</a></span>()
<span class="fu"><a href="https://rdrr.io/r/stats/heatmap.html">heatmap</a></span>(<span class="no">z_mat</span>)</pre></body></html></div>
<p><img src="embedding_prediction_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<div class="sourceCode" id="cb100"><html><body><pre class="r"><span class="co"># learning embeddings across the two tables</span>
<span class="no">conf</span> <span class="kw">&lt;-</span> <span class="no">umap.defaults</span>
<span class="no">conf</span>$<span class="no">min_dist</span> <span class="kw">&lt;-</span> <span class="fl">0.8</span>
<span class="no">embeddings</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/umap/man/umap.html">umap</a></span>(<span class="no">z_mat</span>, <span class="no">conf</span>)
<span class="no">embeddings_df</span> <span class="kw">&lt;-</span> <span class="no">embeddings</span>$<span class="no">layout</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span>(<span class="kw">.name_repair</span> <span class="kw">=</span> <span class="st">"universal"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span>(<span class="st">"l1"</span> <span class="kw">=</span> <span class="no">`...1`</span>, <span class="st">"l2"</span> <span class="kw">=</span> <span class="no">`...2`</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">sample_by_cell</span> <span class="kw">=</span> <span class="no">z</span>$<span class="no">sample_by_cell</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span>(<span class="no">col_df</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span>(<span class="no">z</span>)</pre></body></html></div>
<pre><code>## New names:
## * `` -&gt; ...1
## * `` -&gt; ...2</code></pre>
<pre><code>## Joining, by = "sample_by_cell"
## Joining, by = "sample_by_cell"</code></pre>
<p>We’ll plot the embeddings we just made, against some of the derived features.</p>
<div class="sourceCode" id="cb103"><html><body><pre class="r"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">embeddings_df</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span>(<span class="kw">yintercept</span> <span class="kw">=</span> <span class="fl">0</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span>(<span class="kw">xintercept</span> <span class="kw">=</span> <span class="fl">0</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">l1</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">l2</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="no">cell_group</span>),
    <span class="kw">size</span> <span class="kw">=</span> <span class="fl">0.5</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.7</span>
  ) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(~<span class="no">SampleID</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_color_brewer</a></span>(<span class="kw">palette</span> <span class="kw">=</span> <span class="st">"Set2"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span>(<span class="kw">col</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span>(<span class="kw">override.aes</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="fl">5</span>))) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"Cell Types"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"bottom"</span>)</pre></body></html></div>
<p><img src="embedding_prediction_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<div class="sourceCode" id="cb104"><html><body><pre class="r"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">embeddings_df</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">l1</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">l2</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="no">Fe</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(~ <span class="no">SampleID</span>) +
  <span class="fu"><a href="https://rdrr.io/pkg/viridis/man/scale_viridis.html">scale_color_viridis</a></span>(<span class="kw">option</span> <span class="kw">=</span> <span class="st">"inferno"</span>)</pre></body></html></div>
<p><img src="embedding_prediction_files/figure-html/unnamed-chunk-6-2.png" width="700"></p>
<div class="sourceCode" id="cb105"><html><body><pre class="r"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">embeddings_df</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span>(<span class="kw">yintercept</span> <span class="kw">=</span> <span class="fl">0</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span>(<span class="kw">xintercept</span> <span class="kw">=</span> <span class="fl">0</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">l1</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">l2</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="no">graph_neighbors_Macrophages</span>)),
    <span class="kw">size</span> <span class="kw">=</span> <span class="fl">0.5</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.7</span>
  ) +
  <span class="fu"><a href="https://rdrr.io/pkg/viridis/man/scale_viridis.html">scale_color_viridis</a></span>(<span class="kw">option</span> <span class="kw">=</span> <span class="st">"inferno"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(~ <span class="no">SampleID</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"bottom"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"Prop. Neighbors are Macrophages"</span>)</pre></body></html></div>
<p><img src="embedding_prediction_files/figure-html/unnamed-chunk-6-3.png" width="700"></p>
<div id="cells-to-samples" class="section level1">
<h1 class="hasAnchor">
<a href="#cells-to-samples" class="anchor"></a>Cells <span class="math inline">\(\to\)</span> Samples</h1>
<p>Now that we have embeddings at the cell level, we can try to summarize samples by how many of their cells lie in different regions of the embedding space. First, we’ll cluster using an arbitrary <span class="math inline">\(K\)</span>.</p>
<div class="sourceCode" id="cb106"><html><body><pre class="r"><span class="no">clusters</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/kmeans.html">kmeans</a></span>(<span class="no">embeddings</span>$<span class="no">layout</span>, <span class="kw">centers</span> <span class="kw">=</span> <span class="no">params</span>$<span class="no">cluster_K</span>)

<span class="co"># plot the clusters</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">embeddings_df</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">l1</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">l2</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="no">cell_group</span>),
    <span class="kw">size</span> <span class="kw">=</span> <span class="fl">0.5</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.1</span>
  ) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_text</a></span>(
    <span class="kw">data</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="no">clusters</span>$<span class="no">centers</span>, <span class="kw">cluster</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/raster/man/ncell.html">nrow</a></span>(<span class="no">clusters</span>$<span class="no">centers</span>))),
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">X1</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">X2</span>, <span class="kw">label</span> <span class="kw">=</span> <span class="no">cluster</span>), <span class="kw">size</span> <span class="kw">=</span> <span class="fl">5</span>
  ) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span>(<span class="kw">yintercept</span> <span class="kw">=</span> <span class="fl">0</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span>(<span class="kw">xintercept</span> <span class="kw">=</span> <span class="fl">0</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span>(<span class="kw">col</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span>(<span class="kw">override.aes</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="fl">5</span>))) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(~<span class="no">SampleID</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"Clusters vs. Cell Types"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"bottom"</span>)</pre></body></html></div>
<p><img src="embedding_prediction_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<div class="sourceCode" id="cb107"><html><body><pre class="r"><span class="co"># summarize the samples</span>
<span class="no">embeddings_df</span>$<span class="no">cluster</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/as_factor.html">as_factor</a></span>(<span class="no">clusters</span>$<span class="no">cluster</span>)
<span class="no">cluster_props</span> <span class="kw">&lt;-</span> <span class="no">embeddings_df</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="no">SampleID</span>, <span class="no">cluster</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(<span class="kw">count</span> <span class="kw">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span>()) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="no">SampleID</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(
    <span class="kw">total</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">count</span>),
    <span class="kw">prop</span> <span class="kw">=</span> <span class="no">count</span> / <span class="no">total</span>
    ) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span>(
    <span class="no">col_df</span> <span class="kw">%&gt;%</span>
      <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">SampleID</span>, <span class="no">GRADE</span>) <span class="kw">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/pkg/raster/man/unique.html">unique</a></span>()
  )</pre></body></html></div>
<pre><code>## `summarise()` regrouping output by 'SampleID' (override with `.groups` argument)</code></pre>
<pre><code>## Joining, by = "SampleID"</code></pre>
<div class="sourceCode" id="cb110"><html><body><pre class="r"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">cluster_props</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/factor.html">as.factor</a></span>(<span class="no">SampleID</span>), <span class="kw">y</span> <span class="kw">=</span> <span class="no">prop</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">cluster</span>),
    <span class="kw">position</span> <span class="kw">=</span> <span class="st">"stack"</span>, <span class="kw">stat</span> <span class="kw">=</span> <span class="st">"identity"</span>
  ) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="kw">expand</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>, <span class="fl">0</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html">scale_x_discrete</a></span>(<span class="kw">expand</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>, <span class="fl">0</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span>(<span class="no">.</span>~<span class="no">GRADE</span>, <span class="kw">scales</span><span class="kw">=</span><span class="st">"free_x"</span>, <span class="kw">space</span><span class="kw">=</span><span class="st">"free_x"</span>)</pre></body></html></div>
<p><img src="embedding_prediction_files/figure-html/unnamed-chunk-7-2.png" width="700"></p>
<p>Question: Can you map the different clusters back to the spatial patterns that we had noticed from before? E.g., are those in cluster “5” more spatially heterogeneous?</p>
<p>To answer this, let’s compare samples 23, 27, 2 with 10 and 12. These samples seem to have pretty different cluster compositions, even though they both lie in the grade 3 group.</p>
<div class="sourceCode" id="cb111"><html><body><pre class="r"><span class="no">polys_q</span> <span class="kw">&lt;-</span> <span class="no">polys_df</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">SampleID</span> <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"23"</span>, <span class="st">"27"</span>, <span class="st">"2"</span>, <span class="st">"10"</span>, <span class="st">"12"</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">compare</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="no">SampleID</span> <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"10"</span>, <span class="st">"12"</span>), <span class="st">"group2"</span>, <span class="st">"group1"</span>))

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">polys_q</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">fill</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/factor.html">as.factor</a></span>(<span class="no">tumorYN</span>))) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(<span class="no">compare</span> ~ <span class="no">SampleID</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"bottom"</span>)</pre></body></html></div>
<p><img src="embedding_prediction_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<p>I’m not sure I’d have put 10 and 12 that close to one another, since 10 has lots of empty space, but at least the first three do seem qualitatively similar.</p>
<p>In fact, we can compare many of the spatial images, based on the ordering we just defined.</p>
<div class="sourceCode" id="cb112"><html><body><pre class="r"><span class="no">cluster_props_wide</span> <span class="kw">&lt;-</span> <span class="no">cluster_props</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/cast.html">dcast</a></span>(<span class="no">SampleID</span> ~ <span class="no">cluster</span>, <span class="kw">value.var</span> <span class="kw">=</span> <span class="st">"prop"</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="fl">0</span>)

 <span class="no">sample_order</span> <span class="kw">&lt;-</span> <span class="no">cluster_props_wide</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/dist.html">dist</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/hclust.html">hclust</a></span>()
<span class="no">sample_order</span> <span class="kw">&lt;-</span> <span class="no">sample_order</span>$<span class="no">order</span>

<span class="no">polys_df</span> <span class="kw">&lt;-</span> <span class="no">polys_df</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">SampleID</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">SampleID</span>, <span class="kw">levels</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.character.html">as.character</a></span>(<span class="no">cluster_props_wide</span>$<span class="no">SampleID</span>[<span class="no">sample_order</span>])))

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">polys_df</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">SampleID</span> <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/factor.html">levels</a></span>(<span class="no">polys_df</span>$<span class="no">SampleID</span>)[<span class="fl">1</span>:<span class="fl">12</span>])) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">fill</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/factor.html">as.factor</a></span>(<span class="no">tumorYN</span>))) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(<span class="no">GRADE</span> ~ <span class="no">SampleID</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"bottom"</span>)</pre></body></html></div>
<p><img src="embedding_prediction_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<div class="sourceCode" id="cb113"><html><body><pre class="r"><span class="no">tmp</span> <span class="kw">&lt;-</span> <span class="no">cluster_props</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span>(
    <span class="no">col_df</span> <span class="kw">%&gt;%</span>
      <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">SampleID</span>, <span class="no">GRADE</span>) <span class="kw">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/pkg/raster/man/unique.html">unique</a></span>()
  )</pre></body></html></div>
<pre><code>## Joining, by = c("SampleID", "GRADE")</code></pre>
<div class="sourceCode" id="cb115"><html><body><pre class="r"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">tmp</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_dotplot.html">geom_dotplot</a></span>(
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">fill</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/factor.html">as.factor</a></span>(<span class="no">GRADE</span>), <span class="kw">x</span> <span class="kw">=</span> <span class="no">prop</span>)
  ) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(~ <span class="no">cluster</span>)</pre></body></html></div>
<pre><code>## `stat_bindot()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="embedding_prediction_files/figure-html/unnamed-chunk-9-2.png" width="700"></p>
</div>
<div id="guessing-the-embedding" class="section level1">
<h1 class="hasAnchor">
<a href="#guessing-the-embedding" class="anchor"></a>Guessing the Embedding</h1>
<p>We’ll finally load the cytof data to identify shared features. Then, we’ll look at the relationship between those features and the above embeddings, to see if we could map the cytof data into the mibitof embedding space.</p>
<div class="sourceCode" id="cb117"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">data_dir</span>, <span class="st">"masstagSCE.rda"</span>))
<span class="no">masstag</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BIRSBIO2020.scProteomics.embeddings/man/data_list.html">data_list</a></span>(<span class="st">"sce"</span>)
<span class="no">common_antigens</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/intersect.html">intersect</a></span>(<span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames</a></span>(<span class="no">masstag</span>$<span class="no">tcell.sce</span>), <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames</a></span>(<span class="no">mibi_sce</span>))</pre></body></html></div>
<p>I’ll learn a mapping at the cell level, using (1) cell identity and (2) levels of CD68, CD20, CD11b, CD4, CD16, CD163, CD3, CD11c, CD45 to identify the corresponding location in the embedding space. If this is accurate, we could then cluster the imputed cell embeddings, to come up with a new spatial summary of the mass spec data. Otherwise, we would report that the antigen information on its own is not enough to determine the spatial characteristics of the sample.</p>
<p>This prepares the training data, which maps antigen values and cell type indicators to embedding locations.</p>
<div class="sourceCode" id="cb118"><html><body><pre class="r"><span class="no">predictors</span> <span class="kw">&lt;-</span> <span class="no">x</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span>(
    <span class="no">y</span> <span class="kw">%&gt;%</span>
    <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(-<span class="fu"><a href="https://tidyr.tidyverse.org/reference/reexports.html">starts_with</a></span>(<span class="st">"graph"</span>)) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select_all.html">rename_all</a></span>(<span class="no">tolower</span>),
    <span class="kw">by</span> <span class="kw">=</span> <span class="st">"sample_by_cell"</span>
  )

<span class="no">response</span> <span class="kw">&lt;-</span> <span class="no">embeddings_df</span> <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">l1</span>, <span class="no">l2</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.matrix.html">as.matrix</a></span>()

<span class="no">pred_mat</span> <span class="kw">&lt;-</span> <span class="no">predictors</span> <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="fu"><a href="https://dplyr.tidyverse.org/reference/reexports.html">all_of</a></span>(<span class="no">common_antigens</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.matrix.html">as.matrix</a></span>()

<span class="no">model</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BIRSBIO2020.scProteomics.embeddings/man/generate_model.html">generate_model</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/raster/man/ncell.html">ncol</a></span>(<span class="no">pred_mat</span>))
<span class="no">model</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/reexports.html">fit</a></span>(<span class="no">pred_mat</span>, <span class="no">response</span>, <span class="kw">epochs</span><span class="kw">=</span><span class="fl">200</span>, <span class="kw">batch_size</span><span class="kw">=</span><span class="fl">1024</span>)</pre></body></html></div>
<div class="sourceCode" id="cb119"><html><body><pre class="r"><span class="no">y_hat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/predict.html">predict</a></span>(<span class="no">model</span>, <span class="no">pred_mat</span>)
<span class="fu"><a href="https://rdrr.io/pkg/stars/man/plot.html">plot</a></span>(<span class="no">response</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">0.1</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html">rgb</a></span>(<span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0.1</span>))
<span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span>(<span class="no">y_hat</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">0.1</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html">rgb</a></span>(<span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0.1</span>))</pre></body></html></div>
<p><img src="embedding_prediction_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
<p>What happens when we summarize these samples by these predicted cluster memberships? Ideally, you would be able to recognize the original cluster compositions, which should reflect spatial expression patterns (if they don’t already).</p>
<p>In the worst case, the imputed cluster compositions would be totally unrelated to the real (known, for the MIBI-ToF data) compositions.</p>
<p>We can compare this with what the predictions would have been if we had used all the antigens (but no explicit spatial information).</p>
<div class="sourceCode" id="cb120"><html><body><pre class="r"><span class="no">pred_mat</span> <span class="kw">&lt;-</span> <span class="no">predictors</span> <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(-<span class="no">sample_by_cell</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.matrix.html">as.matrix</a></span>()

<span class="no">model</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BIRSBIO2020.scProteomics.embeddings/man/generate_model.html">generate_model</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/raster/man/ncell.html">ncol</a></span>(<span class="no">pred_mat</span>))
<span class="no">model</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/reexports.html">fit</a></span>(<span class="no">pred_mat</span>, <span class="no">response</span>, <span class="kw">epochs</span><span class="kw">=</span><span class="fl">200</span>, <span class="kw">batch_size</span><span class="kw">=</span><span class="fl">1024</span>)</pre></body></html></div>
<div class="sourceCode" id="cb121"><html><body><pre class="r"><span class="no">y_hat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/predict.html">predict</a></span>(<span class="no">model</span>, <span class="no">pred_mat</span>)
<span class="fu"><a href="https://rdrr.io/pkg/stars/man/plot.html">plot</a></span>(<span class="no">response</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">0.1</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html">rgb</a></span>(<span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0.1</span>))
<span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span>(<span class="no">y_hat</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">0.1</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html">rgb</a></span>(<span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0.1</span>))</pre></body></html></div>
<p><img src="embedding_prediction_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p><a href="mailto:ksankaran@wisc.edu" class="email">ksankaran@wisc.edu</a><a href="#fnref1" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Kris Sankaran.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
