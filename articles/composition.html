<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Disentangling Composition and Spatial Effects • BIRSBIO2020.scProteomics.embeddings</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Disentangling Composition and Spatial Effects">
<meta property="og:description" content="BIRSBIO2020.scProteomics.embeddings">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-93043521-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-93043521-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">BIRSBIO2020.scProteomics.embeddings</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/composition.html">Disentangling Composition and Spatial Effects</a>
    </li>
    <li>
      <a href="../articles/derived_statistics.html">Features from MIBI Segmentations</a>
    </li>
    <li>
      <a href="../articles/embedding_prediction.html">Mapping between Embeddings</a>
    </li>
    <li>
      <a href="../articles/interactive.html">Interactive Visualization using Linked Views</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/seandavi/BuildABiocWorkshop2020">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="composition_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Disentangling Composition and Spatial Effects</h1>
                        <h4 class="author">Kris Sankaran<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>
</h4>
            
      
      
      <div class="hidden name"><code>composition.Rmd</code></div>

    </div>

    
    
<ul>
<li>Question we answer in this vignette: to what extent can spatial features from MIBI-ToF data be identified from the composition of cells.</li>
<li>More direct question: We know that if a sample has only one cell type, then it cannot have mixing. We want to push this thinking further.
<ul>
<li>Can you determine spatial properties (like the amount of mixing between cell types, the cell density of the sample) from just the composition of cells that are present?</li>
<li>This is an interesting question because
<ul>
<li>Spatial properties are known to be predictive of certain disease characteristics, and can now be directly interrogated using technology like MIBI-ToF</li>
<li>Cell type can be directly measured using cheaper masstag technologies</li>
</ul>
</li>
</ul>
</li>
<li>Our approach has two parts,
<ul>
<li>FIrst we use MIBI-TOF spatial information to extract spatial features of interest</li>
<li>We cluster the cells according to protein expression values</li>
<li>We predict spatial properties based on proportions of cell clusters</li>
</ul>
</li>
<li>Reason for clustering according to expression values is that we may want to use a more granular collection of clusters than are available from prior analysis / which are designed for human consumption.</li>
</ul>
<p>First, let’s load the libraries needed in this vignette.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"SummarizedExperiment"</span>)</pre></body></html></div>
<pre><code>## Loading required package: GenomicRanges</code></pre>
<pre><code>## Loading required package: stats4</code></pre>
<pre><code>## Loading required package: BiocGenerics</code></pre>
<pre><code>## Loading required package: parallel</code></pre>
<pre><code>## 
## Attaching package: 'BiocGenerics'</code></pre>
<pre><code>## The following objects are masked from 'package:parallel':
## 
##     clusterApply, clusterApplyLB, clusterCall, clusterEvalQ,
##     clusterExport, clusterMap, parApply, parCapply, parLapply,
##     parLapplyLB, parRapply, parSapply, parSapplyLB</code></pre>
<pre><code>## The following objects are masked from 'package:stats':
## 
##     IQR, mad, sd, var, xtabs</code></pre>
<pre><code>## The following objects are masked from 'package:base':
## 
##     anyDuplicated, append, as.data.frame, basename, cbind, colnames,
##     dirname, do.call, duplicated, eval, evalq, Filter, Find, get, grep,
##     grepl, intersect, is.unsorted, lapply, Map, mapply, match, mget,
##     order, paste, pmax, pmax.int, pmin, pmin.int, Position, rank,
##     rbind, Reduce, rownames, sapply, setdiff, sort, table, tapply,
##     union, unique, unsplit, which.max, which.min</code></pre>
<pre><code>## Loading required package: S4Vectors</code></pre>
<pre><code>## 
## Attaching package: 'S4Vectors'</code></pre>
<pre><code>## The following object is masked from 'package:base':
## 
##     expand.grid</code></pre>
<pre><code>## Loading required package: IRanges</code></pre>
<pre><code>## Loading required package: GenomeInfoDb</code></pre>
<pre><code>## Loading required package: Biobase</code></pre>
<pre><code>## Welcome to Bioconductor
## 
##     Vignettes contain introductory material; view with
##     'browseVignettes()'. To cite Bioconductor, see
##     'citation("Biobase")', and for packages 'citation("pkgname")'.</code></pre>
<pre><code>## Loading required package: DelayedArray</code></pre>
<pre><code>## Loading required package: Matrix</code></pre>
<pre><code>## 
## Attaching package: 'Matrix'</code></pre>
<pre><code>## The following object is masked from 'package:S4Vectors':
## 
##     expand</code></pre>
<pre><code>## Loading required package: matrixStats</code></pre>
<pre><code>## 
## Attaching package: 'matrixStats'</code></pre>
<pre><code>## The following objects are masked from 'package:Biobase':
## 
##     anyMissing, rowMedians</code></pre>
<pre><code>## 
## Attaching package: 'DelayedArray'</code></pre>
<pre><code>## The following objects are masked from 'package:matrixStats':
## 
##     colMaxs, colMins, colRanges, rowMaxs, rowMins, rowRanges</code></pre>
<pre><code>## The following objects are masked from 'package:base':
## 
##     aperm, apply, rowsum</code></pre>
<div class="sourceCode" id="cb27"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"dplyr"</span>)</pre></body></html></div>
<pre><code>## 
## Attaching package: 'dplyr'</code></pre>
<pre><code>## The following object is masked from 'package:matrixStats':
## 
##     count</code></pre>
<pre><code>## The following object is masked from 'package:Biobase':
## 
##     combine</code></pre>
<pre><code>## The following objects are masked from 'package:GenomicRanges':
## 
##     intersect, setdiff, union</code></pre>
<pre><code>## The following object is masked from 'package:GenomeInfoDb':
## 
##     intersect</code></pre>
<pre><code>## The following objects are masked from 'package:IRanges':
## 
##     collapse, desc, intersect, setdiff, slice, union</code></pre>
<pre><code>## The following objects are masked from 'package:S4Vectors':
## 
##     first, intersect, rename, setdiff, setequal, union</code></pre>
<pre><code>## The following objects are masked from 'package:BiocGenerics':
## 
##     combine, intersect, setdiff, union</code></pre>
<pre><code>## The following objects are masked from 'package:stats':
## 
##     filter, lag</code></pre>
<pre><code>## The following objects are masked from 'package:base':
## 
##     intersect, setdiff, setequal, union</code></pre>
<div class="sourceCode" id="cb38"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"forcats"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"ggplot2"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"igraph"</span>)</pre></body></html></div>
<pre><code>## 
## Attaching package: 'igraph'</code></pre>
<pre><code>## The following objects are masked from 'package:dplyr':
## 
##     as_data_frame, groups, union</code></pre>
<pre><code>## The following objects are masked from 'package:DelayedArray':
## 
##     path, simplify</code></pre>
<pre><code>## The following object is masked from 'package:GenomicRanges':
## 
##     union</code></pre>
<pre><code>## The following object is masked from 'package:IRanges':
## 
##     union</code></pre>
<pre><code>## The following object is masked from 'package:S4Vectors':
## 
##     union</code></pre>
<pre><code>## The following objects are masked from 'package:BiocGenerics':
## 
##     normalize, path, union</code></pre>
<pre><code>## The following objects are masked from 'package:stats':
## 
##     decompose, spectrum</code></pre>
<pre><code>## The following object is masked from 'package:base':
## 
##     union</code></pre>
<div class="sourceCode" id="cb48"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"reshape2"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"tibble"</span>)</pre></body></html></div>
<pre><code>## 
## Attaching package: 'tibble'</code></pre>
<pre><code>## The following object is masked from 'package:igraph':
## 
##     as_data_frame</code></pre>
<div class="sourceCode" id="cb51"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"viridis"</span>)</pre></body></html></div>
<pre><code>## Loading required package: viridisLite</code></pre>
<div class="sourceCode" id="cb53"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"BIRSBIO2020.scProteomics.embeddings"</span>)
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>() + <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">panel.grid</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span>()))</pre></body></html></div>
<p>Now we’ll download data for analysis, if it’s not already present.</p>
<div class="sourceCode" id="cb54"><html><body><pre class="r"><span class="no">data_dir</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span>(<span class="st">"HOME"</span>), <span class="st">"Data"</span>)
<span class="no">data_paths</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BIRSBIO2020.scProteomics.embeddings/man/download_data.html">download_data</a></span>(<span class="no">data_dir</span>)
<span class="no">loaded_</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BIRSBIO2020.scProteomics.embeddings/man/load_mibi.html">load_mibi</a></span>(<span class="no">data_dir</span>)
<span class="no">subsample</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BIRSBIO2020.scProteomics.embeddings/man/spatial_subsample.html">spatial_subsample</a></span>(<span class="no">loaded_</span>$<span class="no">tiffs</span>, <span class="no">loaded_</span>$<span class="no">mibi</span>)</pre></body></html></div>
<pre><code>## [1] "cropping 1/41"
## [1] "cropping 2/41"
## [1] "cropping 3/41"
## [1] "cropping 4/41"
## [1] "cropping 5/41"
## [1] "cropping 6/41"
## [1] "cropping 7/41"
## [1] "cropping 8/41"
## [1] "cropping 9/41"
## [1] "cropping 10/41"
## [1] "cropping 11/41"
## [1] "cropping 12/41"
## [1] "cropping 13/41"
## [1] "cropping 14/41"
## [1] "cropping 15/41"
## [1] "cropping 16/41"
## [1] "cropping 17/41"
## [1] "cropping 18/41"
## [1] "cropping 19/41"
## [1] "cropping 20/41"
## [1] "cropping 21/41"
## [1] "cropping 22/41"
## [1] "cropping 23/41"
## [1] "cropping 24/41"
## [1] "cropping 25/41"
## [1] "cropping 26/41"
## [1] "cropping 27/41"
## [1] "cropping 28/41"
## [1] "cropping 29/41"
## [1] "cropping 30/41"
## [1] "cropping 31/41"
## [1] "cropping 32/41"
## [1] "cropping 33/41"
## [1] "cropping 34/41"
## [1] "cropping 35/41"
## [1] "cropping 36/41"
## [1] "cropping 37/41"
## [1] "cropping 38/41"
## [1] "cropping 39/41"
## [1] "cropping 40/41"
## [1] "cropping 41/41"</code></pre>
<div class="sourceCode" id="cb56"><html><body><pre class="r"><span class="no">ims</span> <span class="kw">&lt;-</span> <span class="no">subsample</span>$<span class="no">ims</span>
<span class="no">mibi_sce</span> <span class="kw">&lt;-</span> <span class="no">subsample</span>$<span class="no">exper</span></pre></body></html></div>
<ul>
<li>get cluster the proteins, and extract compositions from each sample</li>
<li>cell_clusters is the output of <code>kmeans</code> on the original protein expression matrix, and mprops summarizes how many of each cluster each sample has</li>
</ul>
<div class="sourceCode" id="cb57"><html><body><pre class="r"><span class="no">cell_clusters</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/kmeans.html">kmeans</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html">assay</a></span>(<span class="no">mibi_sce</span>)), <span class="no">params</span>$<span class="no">K</span>)</pre></body></html></div>
<pre><code>## Warning: did not converge in 10 iterations</code></pre>
<div class="sourceCode" id="cb59"><html><body><pre class="r"><span class="no">props</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BIRSBIO2020.scProteomics.embeddings/man/sample_proportions.html">sample_proportions</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html">colData</a></span>(<span class="no">mibi_sce</span>)$<span class="no">SampleID</span>, <span class="no">cell_clusters</span>$<span class="no">cluster</span>)
<span class="no">mprops</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="no">props</span>)</pre></body></html></div>
<p>Next, we join the cluster information into high-level sample information. cd_samp has colData summarized at the individual patient level, rather than one row for each cell.</p>
<div class="sourceCode" id="cb60"><html><body><pre class="r"><span class="no">cd</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html">colData</a></span>(<span class="no">mibi_sce</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="kw pkg">tidyr</span><span class="kw ns">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/unite.html">unite</a></span>(<span class="no">scell</span>, <span class="no">SampleID</span>, <span class="no">cellLabelInImage</span>, <span class="kw">remove</span> <span class="kw">=</span> <span class="fl">FALSE</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(
    <span class="kw">cell_type</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BIRSBIO2020.scProteomics.embeddings/man/cell_type.html">cell_type</a></span>(<span class="no">mibi_sce</span>),
    <span class="kw">cell_group</span> <span class="kw">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_lump.html">fct_lump</a></span>(<span class="no">cell_type</span>, <span class="kw">prop</span> <span class="kw">=</span> <span class="fl">0.05</span>),
    <span class="kw">SampleID</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">SampleID</span>, <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames</a></span>(<span class="no">props</span>))
  )

<span class="no">cd_samp</span> <span class="kw">&lt;-</span> <span class="no">cd</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="no">SampleID</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html">summarise_all</a></span>(<span class="kw">function</span>(<span class="no">x</span>) <span class="no">x</span>[<span class="fl">1</span>] ) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">SampleID</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">SampleID</span>, <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames</a></span>(<span class="no">props</span>)))

<span class="no">cluster_ids</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span>(<span class="no">cell_clusters</span>$<span class="no">cluster</span>, <span class="no">cd</span>$<span class="no">scell</span>)</pre></body></html></div>
<p>These are example sample-level cluster compositions, based entirely on antigen information (ignoring spatial information).</p>
<div class="sourceCode" id="cb61"><html><body><pre class="r"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">mprops</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span>(<span class="no">cd_samp</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">SampleID</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">cluster</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="no">Freq</span>))) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span>(<span class="no">.</span> ~ <span class="no">GRADE</span>, <span class="kw">scale</span><span class="kw">=</span><span class="st">"free_x"</span>, <span class="kw">space</span><span class="kw">=</span><span class="st">"free_x"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient</a></span>(<span class="kw">low</span> <span class="kw">=</span> <span class="st">"white"</span>, <span class="kw">high</span> <span class="kw">=</span> <span class="st">"black"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"bottom"</span>)</pre></body></html></div>
<pre><code>## Joining, by = "SampleID"</code></pre>
<p><img src="composition_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<ul>
<li>Next we calculate spatial statistics using the raster data (appropriately transformed into graphs).</li>
<li>Extract local entropy and neighborhood sizes.
<ul>
<li>By local entropy, we mean the entropy of cluster proportion vectors within each cell-centric neighborhood in the sample’s graph</li>
</ul>
</li>
</ul>
<div class="sourceCode" id="cb63"><html><body><pre class="r"><span class="no">sample_names</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(<span class="no">cd_samp</span>$<span class="no">SampleID</span>)
<span class="no">graphs</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>()
<span class="kw">for</span> (<span class="no">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span>(<span class="no">sample_names</span>)) {
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span>(<span class="st">"graph %s/%s"</span>, <span class="no">i</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">sample_names</span>)))
  <span class="no">poly</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BIRSBIO2020.scProteomics.embeddings/man/polygonize.html">polygonize</a></span>(<span class="no">ims</span><span class="kw">[[</span><span class="no">sample_names</span>[<span class="no">i</span>]]]) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">cellLabelInImage</span> <span class="kw">&gt;</span> <span class="fl">1</span>)
  <span class="no">graphs</span><span class="kw">[[</span><span class="no">i</span>]] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BIRSBIO2020.scProteomics.embeddings/man/extract_graph.html">extract_graph</a></span>(<span class="no">poly</span>)
}</pre></body></html></div>
<pre><code>## [1] "graph 1/40"
## [1] "graph 2/40"
## [1] "graph 3/40"
## [1] "graph 4/40"
## [1] "graph 5/40"
## [1] "graph 6/40"
## [1] "graph 7/40"
## [1] "graph 8/40"
## [1] "graph 9/40"
## [1] "graph 10/40"
## [1] "graph 11/40"
## [1] "graph 12/40"
## [1] "graph 13/40"
## [1] "graph 14/40"
## [1] "graph 15/40"
## [1] "graph 16/40"
## [1] "graph 17/40"
## [1] "graph 18/40"
## [1] "graph 19/40"
## [1] "graph 20/40"
## [1] "graph 21/40"
## [1] "graph 22/40"
## [1] "graph 23/40"
## [1] "graph 24/40"
## [1] "graph 25/40"
## [1] "graph 26/40"
## [1] "graph 27/40"
## [1] "graph 28/40"
## [1] "graph 29/40"
## [1] "graph 30/40"
## [1] "graph 31/40"
## [1] "graph 32/40"
## [1] "graph 33/40"
## [1] "graph 34/40"
## [1] "graph 35/40"
## [1] "graph 36/40"
## [1] "graph 37/40"
## [1] "graph 38/40"
## [1] "graph 39/40"
## [1] "graph 40/40"</code></pre>
<div class="sourceCode" id="cb65"><html><body><pre class="r"><span class="no">spatial</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>()
<span class="kw">for</span> (<span class="no">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span>(<span class="no">sample_names</span>)) {
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span>(<span class="st">"spatial stats %s/%s"</span>, <span class="no">i</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">sample_names</span>)))
  <span class="no">SG</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BIRSBIO2020.scProteomics.embeddings/man/subgraphs.html">subgraphs</a></span>(<span class="no">graphs</span><span class="kw">[[</span><span class="no">i</span>]])
  <span class="no">ptrn</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"^"</span>, <span class="no">sample_names</span>[<span class="no">i</span>], <span class="st">"_"</span>)
  <span class="no">clusters_</span> <span class="kw">&lt;-</span> <span class="no">cluster_ids</span>[<span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span>(<span class="no">ptrn</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">cluster_ids</span>))]
  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">clusters_</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span>(<span class="no">ptrn</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">clusters_</span>))

  <span class="no">spatial</span><span class="kw">[[</span><span class="no">sample_names</span>[<span class="no">i</span>]]] <span class="kw">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span>(
    <span class="kw">scell</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">sample_names</span>[<span class="no">i</span>], <span class="st">"_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/igraph/man/V.html">V</a></span>(<span class="no">graphs</span><span class="kw">[[</span><span class="no">i</span>]]))),
    <span class="kw">entropy</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BIRSBIO2020.scProteomics.embeddings/man/entropies.html">entropies</a></span>(<span class="no">SG</span>, <span class="no">clusters_</span>),
    <span class="kw">avg_dists</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BIRSBIO2020.scProteomics.embeddings/man/avg_dists.html">avg_dists</a></span>(<span class="no">SG</span>)
  )
}</pre></body></html></div>
<pre><code>## [1] "spatial stats 1/40"
## [1] "spatial stats 2/40"
## [1] "spatial stats 3/40"
## [1] "spatial stats 4/40"
## [1] "spatial stats 5/40"
## [1] "spatial stats 6/40"
## [1] "spatial stats 7/40"
## [1] "spatial stats 8/40"
## [1] "spatial stats 9/40"
## [1] "spatial stats 10/40"
## [1] "spatial stats 11/40"
## [1] "spatial stats 12/40"
## [1] "spatial stats 13/40"
## [1] "spatial stats 14/40"
## [1] "spatial stats 15/40"
## [1] "spatial stats 16/40"
## [1] "spatial stats 17/40"
## [1] "spatial stats 18/40"
## [1] "spatial stats 19/40"
## [1] "spatial stats 20/40"
## [1] "spatial stats 21/40"
## [1] "spatial stats 22/40"
## [1] "spatial stats 23/40"
## [1] "spatial stats 24/40"
## [1] "spatial stats 25/40"
## [1] "spatial stats 26/40"
## [1] "spatial stats 27/40"
## [1] "spatial stats 28/40"
## [1] "spatial stats 29/40"
## [1] "spatial stats 30/40"
## [1] "spatial stats 31/40"
## [1] "spatial stats 32/40"
## [1] "spatial stats 33/40"
## [1] "spatial stats 34/40"
## [1] "spatial stats 35/40"
## [1] "spatial stats 36/40"
## [1] "spatial stats 37/40"
## [1] "spatial stats 38/40"
## [1] "spatial stats 39/40"
## [1] "spatial stats 40/40"</code></pre>
<p>Now we join in these spatial statistics with the sample-level summaries we computed before.</p>
<div class="sourceCode" id="cb67"><html><body><pre class="r"><span class="no">spatial</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span>(<span class="no">spatial</span>, <span class="kw">.id</span> <span class="kw">=</span> <span class="st">"SampleID"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">SampleID</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">SampleID</span>, <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span>(<span class="no">mprops</span>$<span class="no">SampleID</span>)))

<span class="no">spatial_samp</span> <span class="kw">&lt;-</span> <span class="no">spatial</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span>(<span class="no">cd</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="no">SampleID</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(
    <span class="kw">me</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">entropy</span>),
    <span class="kw">sde</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span>(<span class="no">entropy</span>),
    <span class="kw">mdist</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">avg_dists</span>),
    <span class="kw">sdist</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span>(<span class="no">avg_dists</span>),
    <span class="kw">.groups</span> <span class="kw">=</span> <span class="st">"drop"</span>
  ) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span>(<span class="no">cd_samp</span>)</pre></body></html></div>
<pre><code>## Joining, by = c("SampleID", "scell")</code></pre>
<pre><code>## Joining, by = "SampleID"</code></pre>
<div class="sourceCode" id="cb70"><html><body><pre class="r"><span class="no">spatial_cell</span> <span class="kw">&lt;-</span> <span class="no">spatial</span> <span class="kw">%&gt;%</span>
  <span class="kw pkg">tidyr</span><span class="kw ns">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html">separate</a></span>(<span class="no">scell</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"SampleID"</span>, <span class="st">"cellLabelInImage"</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(
    <span class="kw">cellLabelInImage</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">cellLabelInImage</span>)
  ) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span>(<span class="no">cd</span>)</pre></body></html></div>
<pre><code>## Joining, by = c("SampleID", "cellLabelInImage")</code></pre>
<p>These figures give us a sense of how the new spatial statistics are associated with known sample characteristics. For example, when entropy is large {something happens to the TIL score}.</p>
<div class="sourceCode" id="cb72"><html><body><pre class="r"><span class="co">## overall histograms</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">spatial_cell</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">entropy</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="no">TIL_score</span>))) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_fill_brewer</a></span>(<span class="kw">palette</span> <span class="kw">=</span> <span class="st">"Greens"</span>, <span class="kw">na.value</span> <span class="kw">=</span> <span class="st">"grey"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span>(<span class="no">cell_group</span> ~ <span class="no">.</span>, <span class="kw">scale</span> <span class="kw">=</span> <span class="st">"free"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(
    <span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"bottom"</span>,
    <span class="kw">strip.text.y</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="kw">angle</span> <span class="kw">=</span> <span class="fl">0</span>)
  )</pre></body></html></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="composition_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<div class="sourceCode" id="cb74"><html><body><pre class="r"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">spatial_cell</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">avg_dists</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="no">TIL_score</span>))) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_fill_brewer</a></span>(<span class="kw">palette</span> <span class="kw">=</span> <span class="st">"Greens"</span>, <span class="kw">na.value</span> <span class="kw">=</span> <span class="st">"grey"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span>(<span class="no">cell_group</span> ~ <span class="no">.</span>, <span class="kw">scale</span> <span class="kw">=</span> <span class="st">"free"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(
    <span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"bottom"</span>,
    <span class="kw">strip.text.y</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="kw">angle</span> <span class="kw">=</span> <span class="fl">0</span>)
  )</pre></body></html></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="composition_files/figure-html/unnamed-chunk-6-2.png" width="700"></p>
<div class="sourceCode" id="cb76"><html><body><pre class="r"><span class="no">slev</span> <span class="kw">&lt;-</span> <span class="no">spatial_samp</span> <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">SampleID</span>, <span class="no">mdist</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(<span class="no">mdist</span>) <span class="kw">%&gt;%</span>
  <span class="no">.</span><span class="kw">[[</span><span class="st">"SampleID"</span>]]

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">spatial_cell</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">SampleID</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">SampleID</span>, <span class="kw">levels</span> <span class="kw">=</span> <span class="no">slev</span>))) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">avg_dists</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">entropy</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="no">cell_group</span>),
    <span class="kw">size</span> <span class="kw">=</span> <span class="fl">0.5</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.8</span>
  ) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(~ <span class="no">SampleID</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_fill_brewer</a></span>(<span class="kw">palette</span> <span class="kw">=</span> <span class="st">"Set2"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(
    <span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"bottom"</span>,
    <span class="kw">strip.text.y</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="kw">angle</span> <span class="kw">=</span> <span class="fl">0</span>),
    <span class="kw">panel.spacing</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/reexports.html">unit</a></span>(<span class="fl">0</span>, <span class="st">"cm"</span>)
  )</pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-6-3.png" width="700"></p>
<p>This is just more exploratory analysis of the derived spatial features.</p>
<p>This is how each individual differs in terms of the cell-label entropy of and average pairwise distance of their 5-nearest neighborhoods.</p>
<div class="sourceCode" id="cb77"><html><body><pre class="r"><span class="co">## Sample level plots</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">spatial_samp</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">me</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">Survival_days_capped_2016.1.1</span>),
    <span class="kw">size</span> <span class="kw">=</span> <span class="fl">4</span>
  ) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">me</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">Survival_days_capped_2016.1.1</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="no">TIL_score</span>)),
    <span class="kw">size</span> <span class="kw">=</span> <span class="fl">2</span>
  ) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_color_brewer</a></span>(<span class="kw">palette</span> <span class="kw">=</span> <span class="st">"Greens"</span>, <span class="kw">na.value</span> <span class="kw">=</span> <span class="st">"grey"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"bottom"</span>)</pre></body></html></div>
<pre><code>## Warning: Removed 2 rows containing missing values (geom_point).

## Warning: Removed 2 rows containing missing values (geom_point).</code></pre>
<p><img src="composition_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<div class="sourceCode" id="cb79"><html><body><pre class="r"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">spatial_samp</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">mdist</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">Survival_days_capped_2016.1.1</span>),
    <span class="kw">size</span> <span class="kw">=</span> <span class="fl">4</span>
  ) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">mdist</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">Survival_days_capped_2016.1.1</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="no">TIL_score</span>)),
    <span class="kw">size</span> <span class="kw">=</span> <span class="fl">2</span>
  ) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_color_brewer</a></span>(<span class="kw">palette</span> <span class="kw">=</span> <span class="st">"Greens"</span>, <span class="kw">na.value</span> <span class="kw">=</span> <span class="st">"grey"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"bottom"</span>)</pre></body></html></div>
<pre><code>## Warning: Removed 2 rows containing missing values (geom_point).

## Warning: Removed 2 rows containing missing values (geom_point).</code></pre>
<p><img src="composition_files/figure-html/unnamed-chunk-7-2.png" width="700"></p>
<div class="sourceCode" id="cb81"><html><body><pre class="r"><span class="co">## Cell level plots</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">spatial_cell</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_jitter.html">geom_jitter</a></span>(
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">TIL_score</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">entropy</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="no">SampleID</span>)),
    <span class="kw">size</span> <span class="kw">=</span> <span class="fl">0.8</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.8</span>
  ) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"none"</span>)</pre></body></html></div>
<pre><code>## Warning: Removed 6920 rows containing missing values (geom_point).</code></pre>
<p><img src="composition_files/figure-html/unnamed-chunk-7-3.png" width="700"></p>
<div class="sourceCode" id="cb83"><html><body><pre class="r"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">spatial_cell</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_jitter.html">geom_jitter</a></span>(
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">TIL_score</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">avg_dists</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="no">SampleID</span>)),
    <span class="kw">size</span> <span class="kw">=</span> <span class="fl">0.8</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.8</span>
  ) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"none"</span>)</pre></body></html></div>
<pre><code>## Warning: Removed 6920 rows containing missing values (geom_point).</code></pre>
<p><img src="composition_files/figure-html/unnamed-chunk-7-4.png" width="700"></p>
<ul>
<li>Can we predict properties of the sample-wise entropy distribution based on just the cell compositions?</li>
<li>Is there something about the survival that isn’t captured entirely by the composition information?</li>
<li>First, we prepare covariates and response data. Our covariates are the (square-root transformed) cluster mixture proportions associated with each sample. Remember that these clusters are computed without reference to any spatial information – they are in principle recoverable from masstag technologies alone.</li>
</ul>
<div class="sourceCode" id="cb85"><html><body><pre class="r"><span class="no">spatial_samp</span> <span class="kw">&lt;-</span> <span class="no">spatial_samp</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">SampleID</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">SampleID</span>, <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span>(<span class="no">mprops</span>$<span class="no">SampleID</span>)))

<span class="no">spatial_comp</span> <span class="kw">&lt;-</span> <span class="no">spatial_samp</span> <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">SampleID</span>, <span class="no">me</span>, <span class="no">sde</span>, <span class="no">mdist</span>, <span class="no">sdist</span>, <span class="no">TIL_score</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span>(<span class="no">mprops</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/cast.html">dcast</a></span>(<span class="no">SampleID</span> + <span class="no">me</span> + <span class="no">sde</span> + <span class="no">mdist</span> + <span class="no">sdist</span> + <span class="no">TIL_score</span> ~ <span class="no">cluster</span>)</pre></body></html></div>
<pre><code>## Joining, by = "SampleID"</code></pre>
<pre><code>## Using Freq as value column: use value.var to override.</code></pre>
<div class="sourceCode" id="cb88"><html><body><pre class="r"><span class="no">x</span> <span class="kw">&lt;-</span> <span class="no">spatial_comp</span> <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="fu"><a href="https://dplyr.tidyverse.org/reference/reexports.html">matches</a></span>(<span class="st">"[0-9]+"</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>()</pre></body></html></div>
<p>As our first response, we’ll consider the average cell-centric entropy.</p>
<div class="sourceCode" id="cb89"><html><body><pre class="r"><span class="no">y</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span>(<span class="no">spatial_comp</span>$<span class="no">me</span>))
<span class="no">fits</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BIRSBIO2020.scProteomics.embeddings/man/fit_wrapper.html">fit_wrapper</a></span>(<span class="no">x</span>, <span class="no">y</span>)</pre></body></html></div>
<pre><code>## Loading required package: lattice</code></pre>
<p><img src="composition_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<pre><code>## Random Forest 
## 
## 40 samples
## 20 predictors
## 
## No pre-processing
## Resampling: Bootstrapped (25 reps) 
## Summary of sample sizes: 40, 40, 40, 40, 40, 40, ... 
## Resampling results across tuning parameters:
## 
##   mtry  RMSE       Rsquared   MAE      
##    2    0.7654300  0.6329689  0.6608830
##   11    0.7481673  0.5918056  0.6406360
##   20    0.7678159  0.5454333  0.6487413
## 
## RMSE was used to select the optimal model using the smallest value.
## The final value used for the model was mtry = 11.</code></pre>
<div class="sourceCode" id="cb92"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/BIRSBIO2020.scProteomics.embeddings/man/plot_fits.html">plot_fits</a></span>(<span class="no">x</span>, <span class="no">y</span>, <span class="no">fits</span>$<span class="no">glmnet</span>, <span class="no">fits</span>$<span class="no">rf</span>)</pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-9-2.png" width="700"></p>
<p>It looks like quite a bit, but not all, of the variation in average entropy, can be explained by cell composition. What about the average neighborhood size or standard errors of entropy and neighborhood size?</p>
<div class="sourceCode" id="cb93"><html><body><pre class="r"><span class="no">y</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span>(<span class="no">spatial_comp</span>$<span class="no">mdist</span>))
<span class="no">fits</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BIRSBIO2020.scProteomics.embeddings/man/fit_wrapper.html">fit_wrapper</a></span>(<span class="no">x</span>, <span class="no">y</span>)</pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
<pre><code>## Random Forest 
## 
## 40 samples
## 20 predictors
## 
## No pre-processing
## Resampling: Bootstrapped (25 reps) 
## Summary of sample sizes: 40, 40, 40, 40, 40, 40, ... 
## Resampling results across tuning parameters:
## 
##   mtry  RMSE       Rsquared   MAE      
##    2    0.7363667  0.5149329  0.5746924
##   11    0.7698123  0.4517089  0.5937125
##   20    0.7903212  0.4290423  0.5988052
## 
## RMSE was used to select the optimal model using the smallest value.
## The final value used for the model was mtry = 2.</code></pre>
<div class="sourceCode" id="cb95"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/BIRSBIO2020.scProteomics.embeddings/man/plot_fits.html">plot_fits</a></span>(<span class="no">x</span>, <span class="no">y</span>, <span class="no">fits</span>$<span class="no">glmnet</span>, <span class="no">fits</span>$<span class="no">rf</span>)</pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-10-2.png" width="700"></p>
<div class="sourceCode" id="cb96"><html><body><pre class="r"><span class="no">y</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span>(<span class="no">spatial_comp</span>$<span class="no">sde</span>))
<span class="no">fits</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BIRSBIO2020.scProteomics.embeddings/man/fit_wrapper.html">fit_wrapper</a></span>(<span class="no">x</span>, <span class="no">y</span>)</pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-10-3.png" width="700"></p>
<pre><code>## Random Forest 
## 
## 40 samples
## 20 predictors
## 
## No pre-processing
## Resampling: Bootstrapped (25 reps) 
## Summary of sample sizes: 40, 40, 40, 40, 40, 40, ... 
## Resampling results across tuning parameters:
## 
##   mtry  RMSE      Rsquared    MAE      
##    2    1.039150  0.08108164  0.8093586
##   11    1.068760  0.08547905  0.8348874
##   20    1.091285  0.07768674  0.8511757
## 
## RMSE was used to select the optimal model using the smallest value.
## The final value used for the model was mtry = 2.</code></pre>
<div class="sourceCode" id="cb98"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/BIRSBIO2020.scProteomics.embeddings/man/plot_fits.html">plot_fits</a></span>(<span class="no">x</span>, <span class="no">y</span>, <span class="no">fits</span>$<span class="no">glmnet</span>, <span class="no">fits</span>$<span class="no">rf</span>)</pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-10-4.png" width="700"></p>
<div class="sourceCode" id="cb99"><html><body><pre class="r"><span class="no">y</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span>(<span class="no">spatial_comp</span>$<span class="no">sdist</span>))
<span class="no">fits</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BIRSBIO2020.scProteomics.embeddings/man/fit_wrapper.html">fit_wrapper</a></span>(<span class="no">x</span>, <span class="no">y</span>)</pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-10-5.png" width="700"></p>
<pre><code>## Random Forest 
## 
## 40 samples
## 20 predictors
## 
## No pre-processing
## Resampling: Bootstrapped (25 reps) 
## Summary of sample sizes: 40, 40, 40, 40, 40, 40, ... 
## Resampling results across tuning parameters:
## 
##   mtry  RMSE       Rsquared   MAE      
##    2    0.8673193  0.3014395  0.6332013
##   11    0.8844160  0.2759552  0.6602163
##   20    0.9089142  0.2539209  0.6779493
## 
## RMSE was used to select the optimal model using the smallest value.
## The final value used for the model was mtry = 2.</code></pre>
<div class="sourceCode" id="cb101"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/BIRSBIO2020.scProteomics.embeddings/man/plot_fits.html">plot_fits</a></span>(<span class="no">x</span>, <span class="no">y</span>, <span class="no">fits</span>$<span class="no">glmnet</span>, <span class="no">fits</span>$<span class="no">rf</span>)</pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-10-6.png" width="700"></p>
<p>It seems like average pairwise distance is predictable, though not quite as much as entropy. The standard errors are not predictable using the linear model, but seem okay using the random forest (which I find an odd result…)</p>
<p>What about the TIL score?</p>
<div class="sourceCode" id="cb102"><html><body><pre class="r"><span class="no">y</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span>(<span class="no">spatial_comp</span>$<span class="no">TIL_score</span>))
<span class="no">keep_ix</span> <span class="kw">&lt;-</span> !<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">y</span>)
<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">keep_ix</span>)</pre></body></html></div>
<pre><code>## [1] 25</code></pre>
<div class="sourceCode" id="cb104"><html><body><pre class="r"><span class="no">fits</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BIRSBIO2020.scProteomics.embeddings/man/fit_wrapper.html">fit_wrapper</a></span>(<span class="no">x</span>[<span class="no">keep_ix</span>, ], <span class="no">y</span>[<span class="no">keep_ix</span>])</pre></body></html></div>
<pre><code>## Warning: Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per
## fold</code></pre>
<p><img src="composition_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
<pre><code>## Random Forest 
## 
## 25 samples
## 20 predictors
## 
## No pre-processing
## Resampling: Bootstrapped (25 reps) 
## Summary of sample sizes: 25, 25, 25, 25, 25, 25, ... 
## Resampling results across tuning parameters:
## 
##   mtry  RMSE       Rsquared   MAE      
##    2    0.8860487  0.3030785  0.7628282
##   11    0.9574939  0.2263080  0.8250187
##   20    1.0040624  0.1959210  0.8635180
## 
## RMSE was used to select the optimal model using the smallest value.
## The final value used for the model was mtry = 2.</code></pre>
<div class="sourceCode" id="cb107"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/BIRSBIO2020.scProteomics.embeddings/man/plot_fits.html">plot_fits</a></span>(<span class="no">x</span>[<span class="no">keep_ix</span>, ], <span class="no">y</span>[<span class="no">keep_ix</span>], <span class="no">fits</span>$<span class="no">glmnet</span>, <span class="no">fits</span>$<span class="no">rf</span>)</pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-11-2.png" width="700"></p>
<p>There are so many missing values in TIL score, that I’m not sure whether we’re actually learning anything meaningful here. It may be the case that the entropy and neighborhood size features are predictable, but not the TIL score? I don’t have an explanation for how that could happen, though.</p>
<div id="interpreting-models" class="section level1">
<h1 class="hasAnchor">
<a href="#interpreting-models" class="anchor"></a>Interpreting Models</h1>
<p>Now that we have established {}, we want to dig a bit more deeply into how these fitted models are structured.</p>
<div class="sourceCode" id="cb108"><html><body><pre class="r"><span class="no">y</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span>(<span class="no">spatial_comp</span>$<span class="no">me</span>))
<span class="no">fits</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BIRSBIO2020.scProteomics.embeddings/man/fit_wrapper.html">fit_wrapper</a></span>(<span class="no">x</span>, <span class="no">y</span>)</pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
<pre><code>## Random Forest 
## 
## 40 samples
## 20 predictors
## 
## No pre-processing
## Resampling: Bootstrapped (25 reps) 
## Summary of sample sizes: 40, 40, 40, 40, 40, 40, ... 
## Resampling results across tuning parameters:
## 
##   mtry  RMSE       Rsquared   MAE      
##    2    0.7000307  0.6185171  0.6074797
##   11    0.7202928  0.5155998  0.6093843
##   20    0.7619146  0.4402954  0.6377068
## 
## RMSE was used to select the optimal model using the smallest value.
## The final value used for the model was mtry = 2.</code></pre>
<p>First, let’s study the output of the glmnet model, even though it’s performance is lower.</p>
<div class="sourceCode" id="cb110"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">fits</span>$<span class="no">glmnet</span>$<span class="no">glmnet.fit</span>)</pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<div class="sourceCode" id="cb111"><html><body><pre class="r"><span class="no">beta_hat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(<span class="no">fits</span>$<span class="no">glmnet</span>$<span class="no">glmnet.fit</span>)[, <span class="fl">10</span>]
<span class="no">imp_ix</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="no">beta_hat</span>), <span class="kw">decreasing</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
<span class="no">mx</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">x</span>[, <span class="no">imp_ix</span>[<span class="fl">1</span>:<span class="fl">10</span>] - <span class="fl">1</span>], <span class="kw">y</span> <span class="kw">=</span> <span class="no">y</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html">melt</a></span>(<span class="kw">id.vars</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"y"</span>))

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">mx</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">y</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(~ <span class="no">variable</span>)</pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-13-2.png" width="700"></p>
<div class="sourceCode" id="cb112"><html><body><pre class="r"><span class="no">y_order</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span>(<span class="no">y</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/image.html">image</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="no">y</span>[<span class="no">y_order</span>] / <span class="fl">4</span>, <span class="no">x</span>[<span class="no">y_order</span>, <span class="no">imp_ix</span>[<span class="fl">1</span>:<span class="fl">10</span>] - <span class="fl">1</span>])))</pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-13-3.png" width="700"></p>
<p>It seems that….</p>
<p>How can we interpret the associated clusters?</p>
<div class="sourceCode" id="cb113"><html><body><pre class="r"><span class="no">z</span> <span class="kw">&lt;-</span> <span class="no">cell_clusters</span>$<span class="no">centers</span>
<span class="no">mcenters</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html">melt</a></span>(<span class="no">z</span>, <span class="kw">varnames</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"cluster"</span>, <span class="st">"protein"</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(
    <span class="kw">protein</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">protein</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">z</span>)[<span class="fu"><a href="https://rdrr.io/r/stats/hclust.html">hclust</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/dist.html">dist</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="no">z</span>), <span class="kw">method</span><span class="kw">=</span><span class="st">"manhattan"</span>))$<span class="no">order</span>]),
    <span class="kw">cluster</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">cluster</span>, <span class="fu"><a href="https://rdrr.io/r/stats/hclust.html">hclust</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/dist.html">dist</a></span>(<span class="no">z</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">"manhattan"</span>))$<span class="no">order</span>),
    )

<span class="no">mcenters</span> <span class="kw">&lt;-</span> <span class="no">mcenters</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(
      <span class="kw">cluster</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="fl">0</span>:<span class="fl">20</span>, <span class="kw">levels</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span>(<span class="no">mcenters</span>$<span class="no">cluster</span>))),
      <span class="kw">beta</span> <span class="kw">=</span> <span class="no">beta_hat</span>
    ))</pre></body></html></div>
<pre><code>## Joining, by = "cluster"</code></pre>
<div class="sourceCode" id="cb115"><html><body><pre class="r"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">mcenters</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">protein</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">value</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">beta</span>),
    <span class="kw">stat</span> <span class="kw">=</span> <span class="st">"identity"</span>
  ) +
  <span class="fu"><a href="https://rdrr.io/pkg/viridis/man/scale_viridis.html">scale_fill_viridis</a></span>() +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="kw">limits</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">2</span>, <span class="fl">6</span>), <span class="kw">oob</span> <span class="kw">=</span> <span class="kw pkg">scales</span><span class="kw ns">::</span><span class="no"><a href="https://scales.r-lib.org//reference/oob.html">squish</a></span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(~ <span class="no">cluster</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">axis.text.x</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="kw">angle</span> <span class="kw">=</span> -<span class="fl">90</span>, <span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">0</span>))</pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
<div class="sourceCode" id="cb116"><html><body><pre class="r"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">mcenters</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">beta</span> <span class="kw">!=</span> <span class="fl">0</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">protein</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">value</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">beta</span>),
    <span class="kw">stat</span> <span class="kw">=</span> <span class="st">"identity"</span>
  ) +
  <span class="fu"><a href="https://rdrr.io/pkg/viridis/man/scale_viridis.html">scale_fill_viridis</a></span>() +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="kw">limits</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">2</span>, <span class="fl">6</span>), <span class="kw">oob</span> <span class="kw">=</span> <span class="kw pkg">scales</span><span class="kw ns">::</span><span class="no"><a href="https://scales.r-lib.org//reference/oob.html">squish</a></span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span>(<span class="no">cluster</span> ~ <span class="no">.</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">axis.text.x</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="kw">angle</span> <span class="kw">=</span> -<span class="fl">90</span>, <span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">0</span>))</pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-14-2.png" width="700"></p>
<p>We can make something similar for the random forest model.</p>
</div>
<div id="regressing-proxy-response" class="section level1">
<h1 class="hasAnchor">
<a href="#regressing-proxy-response" class="anchor"></a>Regressing proxy response</h1>
<p>An easy way to tell whether there is additional structure from one source relative to another is to see whether the ability to predict some independently interesting variable changes when you include that source. This is the table-wise analog of variable importance. In principle, we could multitask regress on to several phenotypic variables, but for now, we’ll focus on survival.</p>
<p>There seem to be two general ways to approach this, * Predict using the two tables separately, then together. See to what extent the underlying information is orthogonal. If the information is completely redundant, there is no benefit by combining the separate sources. * Compute the residual of one source, regressing out the other. This is somehow the “leftover” structure, and can also be used for prediction.</p>
<p>We’ll try both approaches here. First, predicting separately, then together.</p>
<div class="sourceCode" id="cb117"><html><body><pre class="r"><span class="no">combined_x</span> <span class="kw">&lt;-</span> <span class="no">spatial_comp</span> <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(-<span class="no">SampleID</span>, -<span class="no">TIL_score</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_at</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span>(<span class="fu"><a href="https://dplyr.tidyverse.org/reference/reexports.html">matches</a></span>(<span class="st">"[0-9]+"</span>)), <span class="no">sqrt</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span>()

<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"survival"</span>)</pre></body></html></div>
<pre><code>## 
## Attaching package: 'survival'</code></pre>
<pre><code>## The following object is masked from 'package:caret':
## 
##     cluster</code></pre>
<div class="sourceCode" id="cb120"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"glmnet"</span>)</pre></body></html></div>
<pre><code>## Loaded glmnet 4.0-2</code></pre>
<div class="sourceCode" id="cb122"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"randomForestSRC"</span>)</pre></body></html></div>
<pre><code>## 
##  randomForestSRC 2.9.3 
##  
##  Type rfsrc.news() to see new features, changes, and bug fixes. 
## </code></pre>
<div class="sourceCode" id="cb124"><html><body><pre class="r"><span class="no">keep_ix</span> <span class="kw">&lt;-</span> !<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">spatial_samp</span>$<span class="no">Survival_days_capped_2016.1.1</span>)
<span class="no">y</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span>(<span class="no">spatial_samp</span>$<span class="no">Survival_days_capped_2016.1.1</span>[<span class="no">keep_ix</span>], <span class="no">spatial_samp</span>$<span class="no">Censored</span>[<span class="no">keep_ix</span>])

<span class="no">surv_glmnet</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/glmnet/man/cv.glmnet.html">cv.glmnet</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span>(<span class="no">combined_x</span>[<span class="no">keep_ix</span>, ]), <span class="no">y</span>, <span class="kw">family</span> <span class="kw">=</span> <span class="st">"cox"</span>)</pre></body></html></div>
<pre><code>## Warning: from glmnet Fortran code (error code -30062); Numerical error at 62th
## lambda value; solutions for larger values of lambda returned</code></pre>
<pre><code>## Warning: from glmnet Fortran code (error code -30071); Numerical error at 71th
## lambda value; solutions for larger values of lambda returned</code></pre>
<pre><code>## Warning: from glmnet Fortran code (error code -30057); Numerical error at 57th
## lambda value; solutions for larger values of lambda returned</code></pre>
<pre><code>## Warning: from glmnet Fortran code (error code -30074); Numerical error at 74th
## lambda value; solutions for larger values of lambda returned</code></pre>
<pre><code>## Warning: from glmnet Fortran code (error code -30049); Numerical error at 49th
## lambda value; solutions for larger values of lambda returned</code></pre>
<pre><code>## Warning: from glmnet Fortran code (error code -30043); Numerical error at 43th
## lambda value; solutions for larger values of lambda returned</code></pre>
<pre><code>## Warning: from glmnet Fortran code (error code -30065); Numerical error at 65th
## lambda value; solutions for larger values of lambda returned</code></pre>
<pre><code>## Warning: from glmnet Fortran code (error code -30058); Numerical error at 58th
## lambda value; solutions for larger values of lambda returned</code></pre>
<div class="sourceCode" id="cb133"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">surv_glmnet</span>)</pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-15-1.png" width="700"></p>
<div class="sourceCode" id="cb134"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">surv_glmnet</span>$<span class="no">glmnet.fit</span>)</pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-15-2.png" width="700"></p>
<div class="sourceCode" id="cb135"><html><body><pre class="r"><span class="no">surv_rf</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/randomForestSRC/man/rfsrc.html">rfsrc</a></span>(<span class="no">y</span> ~ <span class="no">.</span> , <span class="kw">data</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="no">combined_x</span>[<span class="no">keep_ix</span>, ], <span class="kw">y</span> <span class="kw">=</span> <span class="no">y</span>), <span class="kw">mtry</span><span class="kw">=</span><span class="fl">20</span>)
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">surv_rf</span>) <span class="co"># this model is hopeless</span></pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-15-3.png" width="700"></p>
<p>So, it doesn’t seem like survival is so easy to predict, using this information. So, let’s reorient, and try to predict relevant groups of phenotypic information. To do this, we’ll convert the phenotypic metadata into something we can do dimensionality reduction on. But first, is there any correlation between the x matrix we’ve constructed and the characteristics of the people?</p>
<div class="sourceCode" id="cb136"><html><body><pre class="r"><span class="no">fits</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span>(<span class="kw">length</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(<span class="no">cd_samp</span>), <span class="kw">mode</span> <span class="kw">=</span> <span class="st">"list"</span>)
<span class="kw">for</span> (<span class="no">j</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span>(<span class="no">cd_samp</span>)) {
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="no">j</span>)

  <span class="no">y</span> <span class="kw">&lt;-</span> <span class="no">cd_samp</span><span class="kw">[[</span><span class="no">j</span>]]
  <span class="no">fam</span> <span class="kw">&lt;-</span> <span class="st">"gaussian"</span>
  <span class="kw">if</span> (!<span class="fu"><a href="https://rdrr.io/r/base/numeric.html">is.numeric</a></span>(<span class="no">y</span>)) {
    <span class="no">fam</span> <span class="kw">&lt;-</span> <span class="st">"multinomial"</span>
    <span class="no">y</span> <span class="kw">&lt;-</span> <span class="no">y</span> <span class="kw">%&gt;%</span>
      <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_explicit_na.html">fct_explicit_na</a></span>() <span class="kw">%&gt;%</span>
      <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_lump.html">fct_lump</a></span>(<span class="kw">prop</span> <span class="kw">=</span> <span class="fl">.1</span>)

    <span class="kw">for</span> (<span class="no">rare</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Other"</span>, <span class="st">"NULL"</span>, <span class="st">"POSITIVE FOR A DELETERIOUS MUTATION"</span>)) {
      <span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">y</span> <span class="kw">==</span> <span class="no">rare</span>) <span class="kw">&lt;</span> <span class="fl">5</span>) {
        <span class="no">y</span>[<span class="no">y</span> <span class="kw">==</span> <span class="no">rare</span>] <span class="kw">&lt;-</span> <span class="st">"(Missing)"</span>
      }
    }
    <span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">y</span> <span class="kw">==</span> <span class="st">"(Missing)"</span>) <span class="kw">&lt;</span> <span class="fl">5</span>) {
      <span class="no">y</span>[<span class="no">y</span> <span class="kw">==</span> <span class="st">"(Missing)"</span>] <span class="kw">&lt;-</span> <span class="st">"POSITIVE"</span>
    }

    <span class="no">y</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/droplevels.html">droplevels</a></span>(<span class="no">y</span>)
    <span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/nlevels.html">nlevels</a></span>(<span class="no">y</span>) <span class="kw">==</span> <span class="fl">1</span>) <span class="kw">next</span>
  } <span class="kw">else</span> {
    <span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/stats/cor.html">var</a></span>(<span class="no">y</span>, <span class="kw">na.rm</span> <span class="kw">=</span> <span class="no">T</span>) <span class="kw">==</span> <span class="fl">0</span>) <span class="kw">next</span>
    <span class="no">y</span>[<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">y</span>)] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span>(<span class="no">y</span>, <span class="kw">na.rm</span> <span class="kw">=</span> <span class="no">T</span>)
    <span class="no">y</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span>(<span class="no">y</span>)
  }


  <span class="no">fits</span><span class="kw">[[</span><span class="no">j</span>]] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/glmnet/man/cv.glmnet.html">cv.glmnet</a></span>(<span class="no">combined_x</span>[<span class="no">keep_ix</span>, ], <span class="no">y</span>[<span class="no">keep_ix</span>], <span class="kw">family</span><span class="kw">=</span><span class="no">fam</span>)
}</pre></body></html></div>
<pre><code>## [1] 1</code></pre>
<pre><code>## Warning in `[&lt;-.factor`(`*tmp*`, y == rare, value = "(Missing)"): invalid factor
## level, NA generated

## Warning in `[&lt;-.factor`(`*tmp*`, y == rare, value = "(Missing)"): invalid factor
## level, NA generated</code></pre>
<pre><code>## Warning in `[&lt;-.factor`(`*tmp*`, y == "(Missing)", value = "POSITIVE"): invalid
## factor level, NA generated</code></pre>
<pre><code>## [1] 2</code></pre>
<pre><code>## Warning in `[&lt;-.factor`(`*tmp*`, y == rare, value = "(Missing)"): invalid factor
## level, NA generated</code></pre>
<pre><code>## Warning in `[&lt;-.factor`(`*tmp*`, y == rare, value = "(Missing)"): invalid factor
## level, NA generated</code></pre>
<pre><code>## Warning in `[&lt;-.factor`(`*tmp*`, y == "(Missing)", value = "POSITIVE"): invalid
## factor level, NA generated</code></pre>
<pre><code>## [1] 3
## [1] 4
## [1] 5
## [1] 6
## [1] 7
## [1] 8</code></pre>
<pre><code>## Warning in `[&lt;-.factor`(`*tmp*`, y == rare, value = "(Missing)"): invalid factor
## level, NA generated</code></pre>
<pre><code>## Warning in `[&lt;-.factor`(`*tmp*`, y == rare, value = "(Missing)"): invalid factor
## level, NA generated</code></pre>
<pre><code>## Warning in `[&lt;-.factor`(`*tmp*`, y == "(Missing)", value = "POSITIVE"): invalid
## factor level, NA generated</code></pre>
<pre><code>## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground</code></pre>
<pre><code>## Warning: from glmnet Fortran code (error code -91); Convergence for 91th lambda
## value not reached after maxit=100000 iterations; solutions for larger lambdas
## returned</code></pre>
<pre><code>## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground</code></pre>
<pre><code>## Warning: from glmnet Fortran code (error code -87); Convergence for 87th lambda
## value not reached after maxit=100000 iterations; solutions for larger lambdas
## returned</code></pre>
<pre><code>## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground</code></pre>
<pre><code>## [1] 9</code></pre>
<pre><code>## Warning in `[&lt;-.factor`(`*tmp*`, y == rare, value = "(Missing)"): invalid factor
## level, NA generated</code></pre>
<pre><code>## Warning in `[&lt;-.factor`(`*tmp*`, y == rare, value = "(Missing)"): invalid factor
## level, NA generated</code></pre>
<pre><code>## Warning in `[&lt;-.factor`(`*tmp*`, y == "(Missing)", value = "POSITIVE"): invalid
## factor level, NA generated</code></pre>
<pre><code>## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground</code></pre>
<pre><code>## [1] 10
## [1] 11
## [1] 12
## [1] 13
## [1] 14
## [1] 15
## [1] 16</code></pre>
<pre><code>## Warning in `[&lt;-.factor`(`*tmp*`, y == rare, value = "(Missing)"): invalid factor
## level, NA generated</code></pre>
<pre><code>## Warning in `[&lt;-.factor`(`*tmp*`, y == rare, value = "(Missing)"): invalid factor
## level, NA generated</code></pre>
<pre><code>## Warning in `[&lt;-.factor`(`*tmp*`, y == "(Missing)", value = "POSITIVE"): invalid
## factor level, NA generated</code></pre>
<pre><code>## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground</code></pre>
<pre><code>## [1] 17
## [1] 18
## [1] 19</code></pre>
<pre><code>## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground</code></pre>
<pre><code>## [1] 20</code></pre>
<pre><code>## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground</code></pre>
<pre><code>## [1] 21</code></pre>
<pre><code>## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground</code></pre>
<pre><code>## [1] 22</code></pre>
<pre><code>## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground</code></pre>
<pre><code>## [1] 23
## [1] 24
## [1] 25
## [1] 26</code></pre>
<pre><code>## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground</code></pre>
<pre><code>## [1] 27</code></pre>
<pre><code>## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground</code></pre>
<pre><code>## [1] 28</code></pre>
<pre><code>## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground</code></pre>
<pre><code>## [1] 29</code></pre>
<pre><code>## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground</code></pre>
<pre><code>## [1] 30</code></pre>
<pre><code>## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground</code></pre>
<pre><code>## [1] 31</code></pre>
<pre><code>## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground</code></pre>
<pre><code>## [1] 32</code></pre>
<pre><code>## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground</code></pre>
<pre><code>## [1] 33</code></pre>
<pre><code>## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground

## Warning in lognet(x, is.sparse, ix, jx, y, weights, offset, alpha, nobs, : one
## multinomial or binomial class has fewer than 8 observations; dangerous ground</code></pre>
<pre><code>## [1] 34
## [1] 35
## [1] 36
## [1] 37
## [1] 38</code></pre>
<pre><code>## Warning in `[&lt;-.factor`(`*tmp*`, y == rare, value = "(Missing)"): invalid factor
## level, NA generated</code></pre>
<pre><code>## Warning in `[&lt;-.factor`(`*tmp*`, y == rare, value = "(Missing)"): invalid factor
## level, NA generated</code></pre>
<pre><code>## Warning in `[&lt;-.factor`(`*tmp*`, y == "(Missing)", value = "POSITIVE"): invalid
## factor level, NA generated</code></pre>
<pre><code>## [1] 39</code></pre>
<pre><code>## Warning in `[&lt;-.factor`(`*tmp*`, y == rare, value = "(Missing)"): invalid factor
## level, NA generated</code></pre>
<pre><code>## Warning in `[&lt;-.factor`(`*tmp*`, y == rare, value = "(Missing)"): invalid factor
## level, NA generated</code></pre>
<pre><code>## Warning in `[&lt;-.factor`(`*tmp*`, y == "(Missing)", value = "POSITIVE"): invalid
## factor level, NA generated</code></pre>
<div class="sourceCode" id="cb195"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">fits</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">cd_samp</span>)
<span class="no">fits</span></pre></body></html></div>
<pre><code>## $SampleID
## NULL
## 
## $scell
## NULL
## 
## $cellLabelInImage
## 
## Call:  cv.glmnet(x = combined_x[keep_ix, ], y = y[keep_ix], family = fam) 
## 
## Measure: Mean-Squared Error 
## 
##     Lambda Measure     SE Nonzero
## min 0.2563   1.077 0.6410       2
## 1se 0.3389   1.091 0.6365       0
## 
## $cellSize
## 
## Call:  cv.glmnet(x = combined_x[keep_ix, ], y = y[keep_ix], family = fam) 
## 
## Measure: Mean-Squared Error 
## 
##     Lambda Measure     SE Nonzero
## min 0.2623   1.056 0.2570       1
## 1se 0.3159   1.059 0.2572       0
## 
## $tumorYN
## 
## Call:  cv.glmnet(x = combined_x[keep_ix, ], y = y[keep_ix], family = fam) 
## 
## Measure: Mean-Squared Error 
## 
##     Lambda Measure     SE Nonzero
## min 0.2959   1.054 0.2095       2
## 1se 0.5171   1.089 0.2246       0
## 
## $tumorCluster
## 
## Call:  cv.glmnet(x = combined_x[keep_ix, ], y = y[keep_ix], family = fam) 
## 
## Measure: Mean-Squared Error 
## 
##     Lambda Measure     SE Nonzero
## min 0.2464  0.9388 0.4534       2
## 1se 0.5692  1.0528 0.4540       0
## 
## $immuneCluster
## 
## Call:  cv.glmnet(x = combined_x[keep_ix, ], y = y[keep_ix], family = fam) 
## 
## Measure: Mean-Squared Error 
## 
##     Lambda Measure     SE Nonzero
## min 0.2214  0.5707 0.1682       3
## 1se 0.4247  0.7012 0.1832       1
## 
## $tumor_group
## 
## Call:  cv.glmnet(x = combined_x[keep_ix, ], y = y[keep_ix], family = fam) 
## 
## Measure: Multinomial Deviance 
## 
##     Lambda Measure     SE Nonzero
## min 0.1334   1.748 0.2359       1
## 1se 0.2332   1.977 0.2569       0
## 
## $immune_group
## 
## Call:  cv.glmnet(x = combined_x[keep_ix, ], y = y[keep_ix], family = fam) 
## 
## Measure: Multinomial Deviance 
## 
##     Lambda Measure     SE Nonzero
## min 0.1298   1.101 0.1326       2
## 1se 0.2268   1.219 0.1768       0
## 
## $DONOR_NO
## 
## Call:  cv.glmnet(x = combined_x[keep_ix, ], y = y[keep_ix], family = fam) 
## 
## Measure: Mean-Squared Error 
## 
##     Lambda Measure     SE Nonzero
## min 0.1717  0.8424 0.1251       6
## 1se 0.3000  0.9597 0.1304       3
## 
## $YEAR
## 
## Call:  cv.glmnet(x = combined_x[keep_ix, ], y = y[keep_ix], family = fam) 
## 
## Measure: Mean-Squared Error 
## 
##     Lambda Measure     SE Nonzero
## min 0.1198  0.9042 0.1584      11
## 1se 0.4017  1.0425 0.1404       1
## 
## $ANON_ID_ONCOSHARE
## 
## Call:  cv.glmnet(x = combined_x[keep_ix, ], y = y[keep_ix], family = fam) 
## 
## Measure: Mean-Squared Error 
## 
##      Lambda Measure     SE Nonzero
## min 0.06375  0.5450 0.1830       9
## 1se 0.13418  0.7233 0.1738       8
## 
## $AGE_AT_DX
## 
## Call:  cv.glmnet(x = combined_x[keep_ix, ], y = y[keep_ix], family = fam) 
## 
## Measure: Mean-Squared Error 
## 
##     Lambda Measure     SE Nonzero
## min 0.3038    1.15 0.2019       1
## 1se 0.3659    1.15 0.2007       0
## 
## $YEARDX
## 
## Call:  cv.glmnet(x = combined_x[keep_ix, ], y = y[keep_ix], family = fam) 
## 
## Measure: Mean-Squared Error 
## 
##     Lambda Measure     SE Nonzero
## min 0.1671  0.8167 0.1675       7
## 1se 0.2920  0.9692 0.1538       4
## 
## $STAGE
## 
## Call:  cv.glmnet(x = combined_x[keep_ix, ], y = y[keep_ix], family = fam) 
## 
## Measure: Mean-Squared Error 
## 
##     Lambda Measure    SE Nonzero
## min 0.3815   1.071 0.249       0
## 1se 0.3815   1.071 0.249       0
## 
## $SITE_02
## 
## Call:  cv.glmnet(x = combined_x[keep_ix, ], y = y[keep_ix], family = fam) 
## 
## Measure: Multinomial Deviance 
## 
##     Lambda Measure      SE Nonzero
## min 0.1093   3.396 0.16041       2
## 1se 0.1909   3.446 0.09917       0
## 
## $LATERAL
## 
## Call:  cv.glmnet(x = combined_x[keep_ix, ], y = y[keep_ix], family = fam) 
## 
## Measure: Mean-Squared Error 
## 
##     Lambda Measure      SE Nonzero
## min 0.2901   1.092 0.08684       0
## 1se 0.2901   1.092 0.08684       0
## 
## $GRADE
## 
## Call:  cv.glmnet(x = combined_x[keep_ix, ], y = y[keep_ix], family = fam) 
## 
## Measure: Mean-Squared Error 
## 
##     Lambda Measure     SE Nonzero
## min 0.6711   1.139 0.7737       0
## 1se 0.6711   1.139 0.7737       0
## 
## $TCODE_P
## 
## Call:  cv.glmnet(x = combined_x[keep_ix, ], y = y[keep_ix], family = fam) 
## 
## Measure: Multinomial Deviance 
## 
##     Lambda Measure     SE Nonzero
## min 0.1998   3.303 0.1503       0
## 1se 0.1998   3.303 0.1503       0
## 
## $NCODE_P
## 
## Call:  cv.glmnet(x = combined_x[keep_ix, ], y = y[keep_ix], family = fam) 
## 
## Measure: Multinomial Deviance 
## 
##     Lambda Measure      SE Nonzero
## min 0.1593    3.35 0.06909       0
## 1se 0.1593    3.35 0.06909       0
## 
## $MCODE_P
## 
## Call:  cv.glmnet(x = combined_x[keep_ix, ], y = y[keep_ix], family = fam) 
## 
## Measure: Multinomial Deviance 
## 
##     Lambda Measure     SE Nonzero
## min 0.1423   2.303 0.1247       0
## 1se 0.1423   2.303 0.1247       0
## 
## $AJCC_P
## 
## Call:  cv.glmnet(x = combined_x[keep_ix, ], y = y[keep_ix], family = fam) 
## 
## Measure: Multinomial Deviance 
## 
##     Lambda Measure     SE Nonzero
## min 0.1138   2.157 0.1915       2
## 1se 0.1988   2.161 0.1300       0
## 
## $ER
## NULL
## 
## $PR
## NULL
## 
## $HER2NEU
## NULL
## 
## $CS_TUM_SIZE
## 
## Call:  cv.glmnet(x = combined_x[keep_ix, ], y = y[keep_ix], family = fam) 
## 
## Measure: Multinomial Deviance 
## 
##      Lambda Measure     SE Nonzero
## min 0.06143   1.101 0.2082       6
## 1se 0.14190   1.105 0.1986       0
## 
## $RESULT_GENE_1
## 
## Call:  cv.glmnet(x = combined_x[keep_ix, ], y = y[keep_ix], family = fam) 
## 
## Measure: Multinomial Deviance 
## 
##     Lambda Measure     SE Nonzero
## min 0.1827  0.8529 0.2482       0
## 1se 0.1827  0.8529 0.2482       0
## 
## $RESULT_MUTATION_1
## 
## Call:  cv.glmnet(x = combined_x[keep_ix, ], y = y[keep_ix], family = fam) 
## 
## Measure: Multinomial Deviance 
## 
##      Lambda Measure     SE Nonzero
## min 0.01482  0.5341 0.2307       7
## 1se 0.12591  0.7590 0.1870       2
## 
## $TEST_OFFERING_1
## 
## Call:  cv.glmnet(x = combined_x[keep_ix, ], y = y[keep_ix], family = fam) 
## 
## Measure: Multinomial Deviance 
## 
##     Lambda Measure     SE Nonzero
## min 0.0978  0.9234 0.1431       3
## 1se 0.1709  1.0071 0.1722       0
## 
## $RESULT_GENE_2
## 
## Call:  cv.glmnet(x = combined_x[keep_ix, ], y = y[keep_ix], family = fam) 
## 
## Measure: Multinomial Deviance 
## 
##      Lambda Measure     SE Nonzero
## min 0.08399  0.8342 0.2330       2
## 1se 0.17679  0.9324 0.2142       0
## 
## $RESULT_MUTATION_2
## 
## Call:  cv.glmnet(x = combined_x[keep_ix, ], y = y[keep_ix], family = fam) 
## 
## Measure: Multinomial Deviance 
## 
##      Lambda Measure     SE Nonzero
## min 0.01574  0.6438 0.2543      10
## 1se 0.13373  0.8853 0.2668       1
## 
## $TEST_OFFERING_2
## 
## Call:  cv.glmnet(x = combined_x[keep_ix, ], y = y[keep_ix], family = fam) 
## 
## Measure: Multinomial Deviance 
## 
##      Lambda Measure     SE Nonzero
## min 0.01896  0.7937 0.3137      10
## 1se 0.17679  0.9314 0.2098       0
## 
## $MYRIAD_TEST_RESULT
## 
## Call:  cv.glmnet(x = combined_x[keep_ix, ], y = y[keep_ix], family = fam) 
## 
## Measure: Multinomial Deviance 
## 
##      Lambda Measure     SE Nonzero
## min 0.01727  0.6132 0.2098       8
## 1se 0.10117  0.8126 0.1656       3
## 
## $RECURRENCE_LABEL
## 
## Call:  cv.glmnet(x = combined_x[keep_ix, ], y = y[keep_ix], family = fam) 
## 
## Measure: Multinomial Deviance 
## 
##     Lambda Measure      SE Nonzero
## min 0.1639   1.454 0.03596       0
## 1se 0.1639   1.454 0.03596       0
## 
## $TIL_score
## 
## Call:  cv.glmnet(x = combined_x[keep_ix, ], y = y[keep_ix], family = fam) 
## 
## Measure: Mean-Squared Error 
## 
##      Lambda Measure     SE Nonzero
## min 0.04399  0.6403 0.1383      15
## 1se 0.11152  0.7626 0.1696      11
## 
## $Survival_days_capped_2016.1.1
## 
## Call:  cv.glmnet(x = combined_x[keep_ix, ], y = y[keep_ix], family = fam) 
## 
## Measure: Mean-Squared Error 
## 
##     Lambda Measure     SE Nonzero
## min 0.0335   1.111 0.2930      16
## 1se 0.3426   1.145 0.1517       0
## 
## $Censored
## 
## Call:  cv.glmnet(x = combined_x[keep_ix, ], y = y[keep_ix], family = fam) 
## 
## Measure: Mean-Squared Error 
## 
##     Lambda Measure     SE Nonzero
## min 0.1873   1.099 0.1085       6
## 1se 0.3593   1.100 0.1090       0
## 
## $cell_type
## 
## Call:  cv.glmnet(x = combined_x[keep_ix, ], y = y[keep_ix], family = fam) 
## 
## Measure: Multinomial Deviance 
## 
##     Lambda Measure      SE Nonzero
## min 0.1154   1.448 0.14548       3
## 1se 0.1838   1.473 0.08169       0
## 
## $cell_group
## 
## Call:  cv.glmnet(x = combined_x[keep_ix, ], y = y[keep_ix], family = fam) 
## 
## Measure: Multinomial Deviance 
## 
##     Lambda Measure      SE Nonzero
## min 0.1838   1.384 0.05973       0
## 1se 0.1838   1.384 0.05973       0</code></pre>
<p>Weirdly enough, we seem to be able to predict the year of diagnosis. We can also predict the donor number (not really surprising). Other than that, the only variable I’m really able to predict is TIL score, which makes sense.</p>
<div class="sourceCode" id="cb197"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">fits</span>$<span class="no">YEAR</span>)</pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-17-1.png" width="700"></p>
<div class="sourceCode" id="cb198"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/graphics/image.html">image</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(<span class="no">fits</span>$<span class="no">YEAR</span>$<span class="no">glmnet.fit</span>)) <span class="co"># a bunch of these expression values are correlated. Maybe different types of cancers collected in different years</span></pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-17-2.png" width="700"></p>
<p>Apparently this “using known phenotype” approach to assessing complementary information doesn’t seem to be that promising (we can’t predict anything meaningful other than TIL Score). We’ll also spend more time deriving new features.</p>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p><a href="mailto:ksankaran@wisc.edu" class="email">ksankaran@wisc.edu</a><a href="#fnref1" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Kris Sankaran.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
