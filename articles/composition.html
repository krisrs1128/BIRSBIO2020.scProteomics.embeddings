<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Disentangling Composition and Ecological Effects • BIRSBIO2020.scProteomics.embeddings</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Disentangling Composition and Ecological Effects">
<meta property="og:description" content="BIRSBIO2020.scProteomics.embeddings">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-93043521-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-93043521-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">BIRSBIO2020.scProteomics.embeddings</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/composition.html">Disentangling Composition and Ecological Effects</a>
    </li>
    <li>
      <a href="../articles/derived_statistics.html">Deriving Graph and Image Features</a>
    </li>
    <li>
      <a href="../articles/embedding_prediction.html">Mapping between Cell-Level Embeddings</a>
    </li>
    <li>
      <a href="../articles/interactive.html">Interactive Visualization using Linked Views</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/seandavi/BuildABiocWorkshop2020">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="composition_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Disentangling Composition and Ecological Effects</h1>
                        <h4 class="author">Kris Sankaran<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>
</h4>
            
      
      
      <div class="hidden name"><code>composition.Rmd</code></div>

    </div>

    
    
<p>To what extent can the ecological features of a sample be recovered from the composition of cells that it contains? For example, we know that if a sample had only one type of cell, then it could not have any cell type mixing. More generally, we’d like to know to whether spatial properties of a sample, like tumor heterogeneity, can be recovered from cell composition data alone. This is an interesting question because</p>
<ul>
<li>Spatial properties are known to be predictive of disease progression, as been found by directly interrogating spatial proteomic data (like MIBI-TOF).</li>
<li>Cell type, in contrast to cell spatial features, can be recovered directly from cheaper cytof-type technologies.</li>
</ul>
<p>At a low level, we’re asking to what extent cytof can be used as a proxy for spatial proteomic sensors. Viewed more broadly, though, the methodological question that this problem reflects is, can we measure whether a new data source provides truly new information, and how can we isolate the conclusions that are attainable through one sensor but not another?</p>
<p>Our approach has two parts,</p>
<ol style="list-style-type: decimal">
<li>First, we use MIBI-TOF spatial information to extract spatial features of interest. These cells are then clustered by protein expression values.</li>
<li>Second, we predict spatial properties based on the proportions of each samples’ cells belonging to each cluster.</li>
</ol>
<p>In step 1, we cluster according to expression values because we want to use a finer-grained definition of cell types than we would typically use.</p>
<p>One tradeoff to note: by defining features at the sample level, we are reducing the sample size – we had many cells, but only a few samples<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>. However, the features for each sample can be more complex than those for individual cells, and this can give a stronger basis from which to relate the different sources of data.</p>
<div id="setup" class="section level1">
<h1 class="hasAnchor">
<a href="#setup" class="anchor"></a>Setup</h1>
<p>First, let’s load the libraries needed in this vignette.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="kw pkg">knitr</span><span class="kw ns">::</span><span class="no"><a href="https://rdrr.io/pkg/knitr/man/opts_chunk.html">opts_chunk</a></span>$<span class="fu">set</span>(<span class="kw">message</span> <span class="kw">=</span> <span class="fl">FALSE</span>, <span class="kw">warning</span> <span class="kw">=</span> <span class="fl">FALSE</span>)</pre></body></html></div>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"SummarizedExperiment"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"dplyr"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"forcats"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"ggplot2"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"igraph"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"reshape2"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"tibble"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"viridis"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"BIRSBIO2020.scProteomics.embeddings"</span>)
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>() + <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">panel.grid</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span>()))</pre></body></html></div>
<p>Now we’ll download data for analysis, if it’s not already present.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">data_dir</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span>(<span class="st">"HOME"</span>), <span class="st">"Data"</span>)
<span class="no">data_paths</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://seandavi.github.io/sars2pack/reference/download_data.html">download_data</a></span>(<span class="no">data_dir</span>)
<span class="no">loaded_</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://seandavi.github.io/sars2pack/reference/load_mibi.html">load_mibi</a></span>(<span class="no">data_dir</span>)
<span class="no">subsample</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://seandavi.github.io/sars2pack/reference/spatial_subsample.html">spatial_subsample</a></span>(<span class="no">loaded_</span>$<span class="no">tiffs</span>, <span class="no">loaded_</span>$<span class="no">mibi</span>)</pre></body></html></div>
<pre><code>## [1] "cropping 1/41"
## [1] "cropping 2/41"
## [1] "cropping 3/41"
## [1] "cropping 4/41"
## [1] "cropping 5/41"
## [1] "cropping 6/41"
## [1] "cropping 7/41"
## [1] "cropping 8/41"
## [1] "cropping 9/41"
## [1] "cropping 10/41"
## [1] "cropping 11/41"
## [1] "cropping 12/41"
## [1] "cropping 13/41"
## [1] "cropping 14/41"
## [1] "cropping 15/41"
## [1] "cropping 16/41"
## [1] "cropping 17/41"
## [1] "cropping 18/41"
## [1] "cropping 19/41"
## [1] "cropping 20/41"
## [1] "cropping 21/41"
## [1] "cropping 22/41"
## [1] "cropping 23/41"
## [1] "cropping 24/41"
## [1] "cropping 25/41"
## [1] "cropping 26/41"
## [1] "cropping 27/41"
## [1] "cropping 28/41"
## [1] "cropping 29/41"
## [1] "cropping 30/41"
## [1] "cropping 31/41"
## [1] "cropping 32/41"
## [1] "cropping 33/41"
## [1] "cropping 34/41"
## [1] "cropping 35/41"
## [1] "cropping 36/41"
## [1] "cropping 37/41"
## [1] "cropping 38/41"
## [1] "cropping 39/41"
## [1] "cropping 40/41"
## [1] "cropping 41/41"</code></pre>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">ims</span> <span class="kw">&lt;-</span> <span class="no">subsample</span>$<span class="no">ims</span>
<span class="no">mibi_sce</span> <span class="kw">&lt;-</span> <span class="no">subsample</span>$<span class="no">exper</span></pre></body></html></div>
</div>
<div id="extract-cell-clusters" class="section level1">
<h1 class="hasAnchor">
<a href="#extract-cell-clusters" class="anchor"></a>Extract cell clusters</h1>
<p>In the next step, we cluster cells across all samples, and then compute the cluster mixing proportions associated with each sample. For clustering, we simply run <code>kmeans</code> on the original protein expression matrix. <code>mprops</code> contains the mixing proportions that we use to summarize the non-spatial features of each sample.</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">cell_clusters</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/kmeans.html">kmeans</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html">assay</a></span>(<span class="no">mibi_sce</span>)), <span class="no">params</span>$<span class="no">K</span>)
<span class="no">props</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://seandavi.github.io/sars2pack/reference/sample_proportions.html">sample_proportions</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html">colData</a></span>(<span class="no">mibi_sce</span>)$<span class="no">SampleID</span>, <span class="no">cell_clusters</span>$<span class="no">cluster</span>)
<span class="no">mprops</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="no">props</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">mprops</span>)</pre></body></html></div>
<pre><code>##   SampleID cluster       Freq
## 1        7       1 0.04819277
## 2        1       1 0.04608295
## 3        8       1 0.01149425
## 4        2       1 0.25161290
## 5        6       1 0.06269592
## 6       27       1 0.20000000</code></pre>
<p>Next, we join the cluster information into high-level sample information. <code>cd_samp</code> has <code>colData</code> summarized at the individual patient level, rather than one row for each cell, so it is a dramatic reduction of the original assay.</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">cd</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html">colData</a></span>(<span class="no">mibi_sce</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="kw pkg">tidyr</span><span class="kw ns">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/unite.html">unite</a></span>(<span class="no">scell</span>, <span class="no">SampleID</span>, <span class="no">cellLabelInImage</span>, <span class="kw">remove</span> <span class="kw">=</span> <span class="fl">FALSE</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(
    <span class="kw">cell_type</span> <span class="kw">=</span> <span class="fu"><a href="https://seandavi.github.io/sars2pack/reference/cell_type.html">cell_type</a></span>(<span class="no">mibi_sce</span>),
    <span class="kw">cell_group</span> <span class="kw">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_lump.html">fct_lump</a></span>(<span class="no">cell_type</span>, <span class="kw">prop</span> <span class="kw">=</span> <span class="fl">0.05</span>),
    <span class="kw">SampleID</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">SampleID</span>, <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames</a></span>(<span class="no">props</span>))
  )

<span class="no">cd_samp</span> <span class="kw">&lt;-</span> <span class="no">cd</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="no">SampleID</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html">summarise_all</a></span>(<span class="kw">function</span>(<span class="no">x</span>) <span class="no">x</span>[<span class="fl">1</span>] ) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">SampleID</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">SampleID</span>, <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames</a></span>(<span class="no">props</span>)))

<span class="no">cluster_ids</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span>(<span class="no">cell_clusters</span>$<span class="no">cluster</span>, <span class="no">cd</span>$<span class="no">scell</span>)</pre></body></html></div>
<p>Below, we plot the sample-level cluster compositions, based entirely protein expression. Each column represent one sample, and each row is one expression cluster. The shading of a cell is the (square root of the) proportion of that sample that belongs in that cluster. Each column summarizes the protein expression (and hence cell type) composition of that sample.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">mprops</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span>(<span class="no">cd_samp</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">SampleID</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">cluster</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="no">Freq</span>))) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span>(<span class="no">.</span> ~ <span class="no">GRADE</span>, <span class="kw">scale</span><span class="kw">=</span><span class="st">"free_x"</span>, <span class="kw">space</span><span class="kw">=</span><span class="st">"free_x"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient</a></span>(<span class="kw">low</span> <span class="kw">=</span> <span class="st">"white"</span>, <span class="kw">high</span> <span class="kw">=</span> <span class="st">"black"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"bottom"</span>)</pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
</div>
<div id="spatial-features" class="section level1">
<h1 class="hasAnchor">
<a href="#spatial-features" class="anchor"></a>Spatial features</h1>
<p>Next we compute the spatial features that we want to associate with the cell type composition information above. These are the ecological features associated with each sample – the data above summarized individual cells, but these data describe their interactions.</p>
<p>We first polygonize the rasters and extract a corresponding KNN graph. For each cell, we extract the order-3 subgraph surrounding it. For each of these subgraphs, we compute the entropy of cluster composition (which reflects tumor heterogeneity) and average pairwise distance (which reflects tumor density).</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="no">sample_names</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(<span class="no">cd_samp</span>$<span class="no">SampleID</span>)
<span class="no">graphs</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>()
<span class="kw">for</span> (<span class="no">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span>(<span class="no">sample_names</span>)) {
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span>(<span class="st">"graph %s/%s"</span>, <span class="no">i</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">sample_names</span>)))
  <span class="no">poly</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://seandavi.github.io/sars2pack/reference/polygonize.html">polygonize</a></span>(<span class="no">ims</span><span class="kw">[[</span><span class="no">sample_names</span>[<span class="no">i</span>]]]) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">cellLabelInImage</span> <span class="kw">&gt;</span> <span class="fl">1</span>)
  <span class="no">graphs</span><span class="kw">[[</span><span class="no">i</span>]] <span class="kw">&lt;-</span> <span class="fu"><a href="https://seandavi.github.io/sars2pack/reference/extract_graph.html">extract_graph</a></span>(<span class="no">poly</span>)
}</pre></body></html></div>
<pre><code>## [1] "graph 1/40"
## [1] "graph 2/40"
## [1] "graph 3/40"
## [1] "graph 4/40"
## [1] "graph 5/40"
## [1] "graph 6/40"
## [1] "graph 7/40"
## [1] "graph 8/40"
## [1] "graph 9/40"
## [1] "graph 10/40"
## [1] "graph 11/40"
## [1] "graph 12/40"
## [1] "graph 13/40"
## [1] "graph 14/40"
## [1] "graph 15/40"
## [1] "graph 16/40"
## [1] "graph 17/40"
## [1] "graph 18/40"
## [1] "graph 19/40"
## [1] "graph 20/40"
## [1] "graph 21/40"
## [1] "graph 22/40"
## [1] "graph 23/40"
## [1] "graph 24/40"
## [1] "graph 25/40"
## [1] "graph 26/40"
## [1] "graph 27/40"
## [1] "graph 28/40"
## [1] "graph 29/40"
## [1] "graph 30/40"
## [1] "graph 31/40"
## [1] "graph 32/40"
## [1] "graph 33/40"
## [1] "graph 34/40"
## [1] "graph 35/40"
## [1] "graph 36/40"
## [1] "graph 37/40"
## [1] "graph 38/40"
## [1] "graph 39/40"
## [1] "graph 40/40"</code></pre>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="no">spatial</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>()
<span class="kw">for</span> (<span class="no">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span>(<span class="no">sample_names</span>)) {
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span>(<span class="st">"spatial stats %s/%s"</span>, <span class="no">i</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">sample_names</span>)))
  <span class="no">SG</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://seandavi.github.io/sars2pack/reference/subgraphs.html">subgraphs</a></span>(<span class="no">graphs</span><span class="kw">[[</span><span class="no">i</span>]])
  <span class="no">ptrn</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"^"</span>, <span class="no">sample_names</span>[<span class="no">i</span>], <span class="st">"_"</span>)
  <span class="no">clusters_</span> <span class="kw">&lt;-</span> <span class="no">cluster_ids</span>[<span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span>(<span class="no">ptrn</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">cluster_ids</span>))]
  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">clusters_</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span>(<span class="no">ptrn</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">clusters_</span>))

  <span class="no">spatial</span><span class="kw">[[</span><span class="no">sample_names</span>[<span class="no">i</span>]]] <span class="kw">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reexports.html">tibble</a></span>(
    <span class="kw">scell</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">sample_names</span>[<span class="no">i</span>], <span class="st">"_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/igraph/man/V.html">V</a></span>(<span class="no">graphs</span><span class="kw">[[</span><span class="no">i</span>]]))),
    <span class="kw">entropy</span> <span class="kw">=</span> <span class="fu"><a href="https://seandavi.github.io/sars2pack/reference/entropies.html">entropies</a></span>(<span class="no">SG</span>, <span class="no">clusters_</span>),
    <span class="kw">avg_dists</span> <span class="kw">=</span> <span class="fu"><a href="https://seandavi.github.io/sars2pack/reference/avg_dists.html">avg_dists</a></span>(<span class="no">SG</span>)
  )
}</pre></body></html></div>
<pre><code>## [1] "spatial stats 1/40"
## [1] "spatial stats 2/40"
## [1] "spatial stats 3/40"
## [1] "spatial stats 4/40"
## [1] "spatial stats 5/40"
## [1] "spatial stats 6/40"
## [1] "spatial stats 7/40"
## [1] "spatial stats 8/40"
## [1] "spatial stats 9/40"
## [1] "spatial stats 10/40"
## [1] "spatial stats 11/40"
## [1] "spatial stats 12/40"
## [1] "spatial stats 13/40"
## [1] "spatial stats 14/40"
## [1] "spatial stats 15/40"
## [1] "spatial stats 16/40"
## [1] "spatial stats 17/40"
## [1] "spatial stats 18/40"
## [1] "spatial stats 19/40"
## [1] "spatial stats 20/40"
## [1] "spatial stats 21/40"
## [1] "spatial stats 22/40"
## [1] "spatial stats 23/40"
## [1] "spatial stats 24/40"
## [1] "spatial stats 25/40"
## [1] "spatial stats 26/40"
## [1] "spatial stats 27/40"
## [1] "spatial stats 28/40"
## [1] "spatial stats 29/40"
## [1] "spatial stats 30/40"
## [1] "spatial stats 31/40"
## [1] "spatial stats 32/40"
## [1] "spatial stats 33/40"
## [1] "spatial stats 34/40"
## [1] "spatial stats 35/40"
## [1] "spatial stats 36/40"
## [1] "spatial stats 37/40"
## [1] "spatial stats 38/40"
## [1] "spatial stats 39/40"
## [1] "spatial stats 40/40"</code></pre>
<p>Now we join in these spatial statistics with the sample-level summaries we computed before. To do this, we first summarize the cell-neighborhood features into features across the entire spatial sample. Here, we simply take the average and variances of these subgraph features, for all subgraphs in the graph.</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="no">spatial</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span>(<span class="no">spatial</span>, <span class="kw">.id</span> <span class="kw">=</span> <span class="st">"SampleID"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">SampleID</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">SampleID</span>, <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span>(<span class="no">mprops</span>$<span class="no">SampleID</span>)))

<span class="no">spatial_samp</span> <span class="kw">&lt;-</span> <span class="no">spatial</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span>(<span class="no">cd</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="no">SampleID</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(
    <span class="kw">me</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">entropy</span>),
    <span class="kw">sde</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span>(<span class="no">entropy</span>),
    <span class="kw">mdist</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">avg_dists</span>),
    <span class="kw">sdist</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span>(<span class="no">avg_dists</span>),
    <span class="kw">.groups</span> <span class="kw">=</span> <span class="st">"drop"</span>
  ) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span>(<span class="no">cd_samp</span>)

<span class="no">spatial_cell</span> <span class="kw">&lt;-</span> <span class="no">spatial</span> <span class="kw">%&gt;%</span>
  <span class="kw pkg">tidyr</span><span class="kw ns">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html">separate</a></span>(<span class="no">scell</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"SampleID"</span>, <span class="st">"cellLabelInImage"</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(
    <span class="kw">cellLabelInImage</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">cellLabelInImage</span>)
  ) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span>(<span class="no">cd</span>)</pre></body></html></div>
<p>These figures give us a sense of how the new spatial statistics are associated with known sample characteristics. For example, the cellular neighborhoods of CD8 cells are generally more varied in expression type than those of keratin-positive tumor cells.</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">spatial_cell</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">entropy</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="no">TIL_score</span>))) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_fill_brewer</a></span>(<span class="kw">palette</span> <span class="kw">=</span> <span class="st">"Greens"</span>, <span class="kw">na.value</span> <span class="kw">=</span> <span class="st">"grey"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span>(<span class="no">cell_group</span> ~ <span class="no">.</span>, <span class="kw">scale</span> <span class="kw">=</span> <span class="st">"free"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(
    <span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"bottom"</span>,
    <span class="kw">strip.text.y</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="kw">angle</span> <span class="kw">=</span> <span class="fl">0</span>)
  )</pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">spatial_cell</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">avg_dists</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="no">TIL_score</span>))) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_fill_brewer</a></span>(<span class="kw">palette</span> <span class="kw">=</span> <span class="st">"Greens"</span>, <span class="kw">na.value</span> <span class="kw">=</span> <span class="st">"grey"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span>(<span class="no">cell_group</span> ~ <span class="no">.</span>, <span class="kw">scale</span> <span class="kw">=</span> <span class="st">"free"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(
    <span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"bottom"</span>,
    <span class="kw">strip.text.y</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="kw">angle</span> <span class="kw">=</span> <span class="fl">0</span>)
  )</pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-7-2.png" width="700"></p>
<div class="sourceCode" id="cb17"><html><body><pre class="r"><span class="no">slev</span> <span class="kw">&lt;-</span> <span class="no">spatial_samp</span> <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">SampleID</span>, <span class="no">mdist</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(<span class="no">mdist</span>) <span class="kw">%&gt;%</span>
  <span class="no">.</span><span class="kw">[[</span><span class="st">"SampleID"</span>]]

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">spatial_cell</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">SampleID</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">SampleID</span>, <span class="kw">levels</span> <span class="kw">=</span> <span class="no">slev</span>))) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">avg_dists</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">entropy</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="no">cell_group</span>),
    <span class="kw">size</span> <span class="kw">=</span> <span class="fl">0.5</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.8</span>
  ) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(~ <span class="no">SampleID</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_fill_brewer</a></span>(<span class="kw">palette</span> <span class="kw">=</span> <span class="st">"Set2"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(
    <span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"bottom"</span>,
    <span class="kw">strip.text.y</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="kw">angle</span> <span class="kw">=</span> <span class="fl">0</span>),
    <span class="kw">panel.spacing</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/reexports.html">unit</a></span>(<span class="fl">0</span>, <span class="st">"cm"</span>)
  )</pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-7-3.png" width="700"></p>
<p>In the figures below, we relate sample characteristics to these extracted features.</p>
<ul>
<li>The first figure plots the relationship between average pairwise distance and entropy of cell neighborhoods, faceted by patient. It shows that different samples tend to have very different values of these features, and that the same cell type can have different spatial properties depending on the patient. It also shows that there are subgroups of patients with similar entropy and density properties (e.g., 28 and 35).</li>
<li>The second figure plots the average subgraph entropy against patient survival, shaded by TIL score, which is a measure of the degree to which each tumor is “invaded” by immune cells. There is no detectable correlation.</li>
<li>The third figure is the analogous plot for average pairwise distance within subgraphs. When the TIL score is low, the average pairwise distance is large.</li>
</ul>
<div class="sourceCode" id="cb18"><html><body><pre class="r"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">spatial_samp</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">me</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">Survival_days_capped_2016.1.1</span>),
    <span class="kw">size</span> <span class="kw">=</span> <span class="fl">4</span>
  ) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">me</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">Survival_days_capped_2016.1.1</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="no">TIL_score</span>)),
    <span class="kw">size</span> <span class="kw">=</span> <span class="fl">2</span>
  ) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_color_brewer</a></span>(<span class="kw">palette</span> <span class="kw">=</span> <span class="st">"Greens"</span>, <span class="kw">na.value</span> <span class="kw">=</span> <span class="st">"grey"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"bottom"</span>)</pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<div class="sourceCode" id="cb19"><html><body><pre class="r"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">spatial_samp</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">mdist</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">Survival_days_capped_2016.1.1</span>),
    <span class="kw">size</span> <span class="kw">=</span> <span class="fl">4</span>
  ) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">mdist</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">Survival_days_capped_2016.1.1</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="no">TIL_score</span>)),
    <span class="kw">size</span> <span class="kw">=</span> <span class="fl">2</span>
  ) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_color_brewer</a></span>(<span class="kw">palette</span> <span class="kw">=</span> <span class="st">"Greens"</span>, <span class="kw">na.value</span> <span class="kw">=</span> <span class="st">"grey"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"bottom"</span>)</pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-8-2.png" width="700"></p>
<p>We can perform similar exploratory analysis at the cell, rather than the patient, level. The figures below expand each sample above into all their component cells.</p>
<pre><code>ggplot(spatial_cell) +
  geom_jitter(
    aes(x = TIL_score, y = entropy, col = as.factor(SampleID)),
    size = 0.8, alpha = 0.8
  ) +
  theme(legend.position = "none")

ggplot(spatial_cell) +
  geom_jitter(
    aes(x = TIL_score, y = avg_dists, col = as.factor(SampleID)),
    size = 0.8, alpha = 0.8
  ) +
  theme(legend.position = "none")</code></pre>
</div>
<div id="relating-data-sources" class="section level1">
<h1 class="hasAnchor">
<a href="#relating-data-sources" class="anchor"></a>Relating data sources</h1>
<p>To resolve the questions posed at the start of this vignette, we will try to predict the sample-wise ecological properties using only the cell cluster compositions. Very high accuracy would suggest high redundancy between these datasets, while low accuracy suggests that the devices are capturing orthogonal sources of variation.</p>
<p>Alternatively, we could relate each table to a single response variable, here, the survival time of each patient. In this supervised analog of the above analysis we see whether adding a new data source increases the ability to predict the response. If the information between these sources is completely redundant, we would expect the performance to remain about the same (or even deteriorate, since fitting will become more challenging in higher dimensions). This approach is deferred to the next section. Understanding the trade-offs between the first (unsupervised, more CCA-like) and second (supervised, PLS-like) analysis is an interesting direction for future work.</p>
<p>First, we prepare the covariates and response data. Our covariates are the (square-root transformed) cluster mixture proportions associated with each sample. Remember that these clusters are computed without reference to any spatial information – they are in principle recoverable from cytof technologies alone.</p>
<div class="sourceCode" id="cb21"><html><body><pre class="r"><span class="no">spatial_samp</span> <span class="kw">&lt;-</span> <span class="no">spatial_samp</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">SampleID</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">SampleID</span>, <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span>(<span class="no">mprops</span>$<span class="no">SampleID</span>)))

<span class="no">spatial_comp</span> <span class="kw">&lt;-</span> <span class="no">spatial_samp</span> <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">SampleID</span>, <span class="no">me</span>, <span class="no">sde</span>, <span class="no">mdist</span>, <span class="no">sdist</span>, <span class="no">TIL_score</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span>(<span class="no">mprops</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/cast.html">dcast</a></span>(<span class="no">SampleID</span> + <span class="no">me</span> + <span class="no">sde</span> + <span class="no">mdist</span> + <span class="no">sdist</span> + <span class="no">TIL_score</span> ~ <span class="no">cluster</span>)

<span class="no">x</span> <span class="kw">&lt;-</span> <span class="no">spatial_comp</span> <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="fu"><a href="https://dplyr.tidyverse.org/reference/reexports.html">matches</a></span>(<span class="st">"[0-9]+"</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>()</pre></body></html></div>
<p>As our first response, we’ll consider the average cell-centric entropy.</p>
<div class="sourceCode" id="cb22"><html><body><pre class="r"><span class="no">y</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span>(<span class="no">spatial_comp</span>$<span class="no">me</span>))
<span class="no">fits</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://seandavi.github.io/sars2pack/reference/fit_wrapper.html">fit_wrapper</a></span>(<span class="no">x</span>, <span class="no">y</span>)</pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
<pre><code>## Random Forest 
## 
## 40 samples
## 20 predictors
## 
## No pre-processing
## Resampling: Bootstrapped (25 reps) 
## Summary of sample sizes: 40, 40, 40, 40, 40, 40, ... 
## Resampling results across tuning parameters:
## 
##   mtry  RMSE       Rsquared   MAE      
##    2    0.6921844  0.6806644  0.5748155
##   11    0.7030967  0.5703709  0.5857473
##   20    0.7363269  0.5070248  0.6115206
## 
## RMSE was used to select the optimal model using the smallest value.
## The final value used for the model was mtry = 2.</code></pre>
<div class="sourceCode" id="cb24"><html><body><pre class="r"><span class="fu"><a href="https://seandavi.github.io/sars2pack/reference/plot_fits.html">plot_fits</a></span>(<span class="no">x</span>, <span class="no">y</span>, <span class="no">fits</span>$<span class="no">glmnet</span>, <span class="no">fits</span>$<span class="no">rf</span>)</pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-10-2.png" width="700"></p>
<p>It looks like quite a bit, but not all, of the variation in average entropy, can be explained by cell composition. What about the average neighborhood size or standard errors of entropy and neighborhood size?</p>
<div class="sourceCode" id="cb25"><html><body><pre class="r"><span class="no">y</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span>(<span class="no">spatial_comp</span>$<span class="no">mdist</span>))
<span class="no">fits</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://seandavi.github.io/sars2pack/reference/fit_wrapper.html">fit_wrapper</a></span>(<span class="no">x</span>, <span class="no">y</span>)</pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
<pre><code>## Random Forest 
## 
## 40 samples
## 20 predictors
## 
## No pre-processing
## Resampling: Bootstrapped (25 reps) 
## Summary of sample sizes: 40, 40, 40, 40, 40, 40, ... 
## Resampling results across tuning parameters:
## 
##   mtry  RMSE       Rsquared   MAE      
##    2    0.6984595  0.5772637  0.5111530
##   11    0.7255317  0.5030249  0.5244293
##   20    0.7526370  0.4702853  0.5539058
## 
## RMSE was used to select the optimal model using the smallest value.
## The final value used for the model was mtry = 2.</code></pre>
<div class="sourceCode" id="cb27"><html><body><pre class="r"><span class="fu"><a href="https://seandavi.github.io/sars2pack/reference/plot_fits.html">plot_fits</a></span>(<span class="no">x</span>, <span class="no">y</span>, <span class="no">fits</span>$<span class="no">glmnet</span>, <span class="no">fits</span>$<span class="no">rf</span>)</pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-11-2.png" width="700"></p>
<div class="sourceCode" id="cb28"><html><body><pre class="r"><span class="no">y</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span>(<span class="no">spatial_comp</span>$<span class="no">sde</span>))
<span class="no">fits</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://seandavi.github.io/sars2pack/reference/fit_wrapper.html">fit_wrapper</a></span>(<span class="no">x</span>, <span class="no">y</span>)</pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-11-3.png" width="700"></p>
<pre><code>## Random Forest 
## 
## 40 samples
## 20 predictors
## 
## No pre-processing
## Resampling: Bootstrapped (25 reps) 
## Summary of sample sizes: 40, 40, 40, 40, 40, 40, ... 
## Resampling results across tuning parameters:
## 
##   mtry  RMSE       Rsquared    MAE      
##    2    0.8948286  0.12128238  0.7160297
##   11    0.9402100  0.11110682  0.7383697
##   20    0.9864336  0.08732524  0.7795593
## 
## RMSE was used to select the optimal model using the smallest value.
## The final value used for the model was mtry = 2.</code></pre>
<div class="sourceCode" id="cb30"><html><body><pre class="r"><span class="fu"><a href="https://seandavi.github.io/sars2pack/reference/plot_fits.html">plot_fits</a></span>(<span class="no">x</span>, <span class="no">y</span>, <span class="no">fits</span>$<span class="no">glmnet</span>, <span class="no">fits</span>$<span class="no">rf</span>)</pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-11-4.png" width="700"></p>
<div class="sourceCode" id="cb31"><html><body><pre class="r"><span class="no">y</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span>(<span class="no">spatial_comp</span>$<span class="no">sdist</span>))
<span class="no">fits</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://seandavi.github.io/sars2pack/reference/fit_wrapper.html">fit_wrapper</a></span>(<span class="no">x</span>, <span class="no">y</span>)</pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-11-5.png" width="700"></p>
<pre><code>## Random Forest 
## 
## 40 samples
## 20 predictors
## 
## No pre-processing
## Resampling: Bootstrapped (25 reps) 
## Summary of sample sizes: 40, 40, 40, 40, 40, 40, ... 
## Resampling results across tuning parameters:
## 
##   mtry  RMSE       Rsquared   MAE      
##    2    0.8276062  0.3408944  0.6091935
##   11    0.8209679  0.3392014  0.6113122
##   20    0.8501928  0.3048869  0.6347743
## 
## RMSE was used to select the optimal model using the smallest value.
## The final value used for the model was mtry = 11.</code></pre>
<div class="sourceCode" id="cb33"><html><body><pre class="r"><span class="fu"><a href="https://seandavi.github.io/sars2pack/reference/plot_fits.html">plot_fits</a></span>(<span class="no">x</span>, <span class="no">y</span>, <span class="no">fits</span>$<span class="no">glmnet</span>, <span class="no">fits</span>$<span class="no">rf</span>)</pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-11-6.png" width="700"></p>
<p>It seems like average pairwise distance is predictable, though not quite as much as entropy. The standard errors are not predictable using the linear model, but seem okay using the random forest (which I find an odd result…)</p>
</div>
<div id="interpreting-models" class="section level1">
<h1 class="hasAnchor">
<a href="#interpreting-models" class="anchor"></a>Interpreting models</h1>
<p>Now that we have seen how we could measure the extent to which information across tables overlap, we will see if we can isolate where any new information came from. For this, we will interpret the models we used to relate the tables.</p>
<div class="sourceCode" id="cb34"><html><body><pre class="r"><span class="no">y</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span>(<span class="no">spatial_comp</span>$<span class="no">me</span>))
<span class="no">fits</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://seandavi.github.io/sars2pack/reference/fit_wrapper.html">fit_wrapper</a></span>(<span class="no">x</span>, <span class="no">y</span>)</pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
<pre><code>## Random Forest 
## 
## 40 samples
## 20 predictors
## 
## No pre-processing
## Resampling: Bootstrapped (25 reps) 
## Summary of sample sizes: 40, 40, 40, 40, 40, 40, ... 
## Resampling results across tuning parameters:
## 
##   mtry  RMSE       Rsquared   MAE      
##    2    0.6939938  0.6219349  0.5808349
##   11    0.7330630  0.4976350  0.6077504
##   20    0.7753926  0.4374836  0.6381822
## 
## RMSE was used to select the optimal model using the smallest value.
## The final value used for the model was mtry = 2.</code></pre>
<p>First, let’s study the output of the glmnet model. Its out-of-sample performance is lower than the random forest’s, but it is more directly amenable to interpretation.</p>
<div class="sourceCode" id="cb36"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">fits</span>$<span class="no">glmnet</span>$<span class="no">glmnet.fit</span>)</pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<div class="sourceCode" id="cb37"><html><body><pre class="r"><span class="no">beta_hat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(<span class="no">fits</span>$<span class="no">glmnet</span>$<span class="no">glmnet.fit</span>)[, <span class="fl">10</span>]
<span class="no">imp_ix</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="no">beta_hat</span>), <span class="kw">decreasing</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
<span class="no">mx</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">x</span>[, <span class="no">imp_ix</span>[<span class="fl">1</span>:<span class="fl">10</span>] - <span class="fl">1</span>], <span class="kw">y</span> <span class="kw">=</span> <span class="no">y</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html">melt</a></span>(<span class="kw">id.vars</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"y"</span>))

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">mx</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">y</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(~ <span class="no">variable</span>)</pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-13-2.png" width="700"></p>
<div class="sourceCode" id="cb38"><html><body><pre class="r"><span class="no">y_order</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span>(<span class="no">y</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/image.html">image</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="no">y</span>[<span class="no">y_order</span>] / <span class="fl">4</span>, <span class="no">x</span>[<span class="no">y_order</span>, <span class="no">imp_ix</span>[<span class="fl">1</span>:<span class="fl">10</span>] - <span class="fl">1</span>])))</pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-13-3.png" width="700"></p>
<p>The plot above shows what the most important predictors look like. Apparently, many clusters have no representation in many samples – these are the vertical bars at zero. However, increasing the number of cells from particular clusters seems clearly related to increases in sample-level entropy. Interestingly, increasing the proportion too much ends up decreasing entropy. This is reasonable in retrospect, since having too many cells from one cluster will preclude any mixing. This nonlinear structure also likely explains why the random forest performed better in this application.</p>
</div>
<div id="interpreting-clusters" class="section level1">
<h1 class="hasAnchor">
<a href="#interpreting-clusters" class="anchor"></a>Interpreting clusters</h1>
<p>In the figure below, we plot the centroid of each cluster. Each panel is a different cluster, and is shaded according to the lasso coefficient associated with that cluster. Each bar is a single protein, and its height is the average expression value of that protein within the cluster.</p>
<div class="sourceCode" id="cb39"><html><body><pre class="r"><span class="no">z</span> <span class="kw">&lt;-</span> <span class="no">cell_clusters</span>$<span class="no">centers</span>
<span class="no">mcenters</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html">melt</a></span>(<span class="no">z</span>, <span class="kw">varnames</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"cluster"</span>, <span class="st">"protein"</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(
    <span class="kw">protein</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">protein</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">z</span>)[<span class="fu"><a href="https://rdrr.io/r/stats/hclust.html">hclust</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/dist.html">dist</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="no">z</span>), <span class="kw">method</span><span class="kw">=</span><span class="st">"manhattan"</span>))$<span class="no">order</span>]),
    <span class="kw">cluster</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">cluster</span>, <span class="fu"><a href="https://rdrr.io/r/stats/hclust.html">hclust</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/dist.html">dist</a></span>(<span class="no">z</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">"manhattan"</span>))$<span class="no">order</span>),
    )

<span class="no">mcenters</span> <span class="kw">&lt;-</span> <span class="no">mcenters</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(
      <span class="kw">cluster</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="fl">0</span>:<span class="fl">20</span>, <span class="kw">levels</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span>(<span class="no">mcenters</span>$<span class="no">cluster</span>))),
      <span class="kw">beta</span> <span class="kw">=</span> <span class="no">beta_hat</span>
    ))

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">mcenters</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">protein</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">value</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">beta</span>),
    <span class="kw">stat</span> <span class="kw">=</span> <span class="st">"identity"</span>
  ) +
  <span class="fu"><a href="https://rdrr.io/pkg/viridis/man/scale_viridis.html">scale_fill_viridis</a></span>() +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="kw">limits</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">2</span>, <span class="fl">6</span>), <span class="kw">oob</span> <span class="kw">=</span> <span class="kw pkg">scales</span><span class="kw ns">::</span><span class="no"><a href="https://scales.r-lib.org//reference/oob.html">squish</a></span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(~ <span class="no">cluster</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">axis.text.x</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="kw">size</span>  <span class="kw">=</span> <span class="fl">5</span>, <span class="kw">angle</span> <span class="kw">=</span> -<span class="fl">90</span>, <span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">0</span>))</pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
<p>Most clusters have no relationship with the response in the lasso model. Below we plot only those with nonzero coefficients. Note that the cluster with the strongest relationship with entropy is the one with a high fraction of expression level for CD8, which is consistent with our observation earlier that CD8 cells are associated wtih higher entropy local neighborhoods.</p>
<div class="sourceCode" id="cb40"><html><body><pre class="r"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">mcenters</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">beta</span> <span class="kw">!=</span> <span class="fl">0</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">protein</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">value</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">beta</span>),
    <span class="kw">stat</span> <span class="kw">=</span> <span class="st">"identity"</span>
  ) +
  <span class="fu"><a href="https://rdrr.io/pkg/viridis/man/scale_viridis.html">scale_fill_viridis</a></span>() +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="kw">limits</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">2</span>, <span class="fl">6</span>), <span class="kw">oob</span> <span class="kw">=</span> <span class="kw pkg">scales</span><span class="kw ns">::</span><span class="no"><a href="https://scales.r-lib.org//reference/oob.html">squish</a></span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span>(<span class="no">cluster</span> ~ <span class="no">.</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">axis.text.x</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="kw">angle</span> <span class="kw">=</span> -<span class="fl">90</span>, <span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">0</span>))</pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-15-1.png" width="700"></p>
<p>We can make something similar for the random forest model.</p>
</div>
<div id="regressing-proxy-response" class="section level1">
<h1 class="hasAnchor">
<a href="#regressing-proxy-response" class="anchor"></a>Regressing proxy response</h1>
<p>An easy way to tell whether there is additional structure from one source relative to another is to see whether the ability to predict some independently interesting variable changes when you include that source. This is the table-wise analog of variable importance. In principle, we could multitask regress on to several phenotypic variables, but for now, we’ll focus on survival.</p>
<p>There seem to be two general ways to carry out this strategy, * Predict using the two tables separately, then together. See to what extent the underlying information is orthogonal. If the information is completely redundant, there is no benefit by combining the separate sources. * Compute the residual of one source, regressing out the other. This is somehow the “leftover” structure, and can also be used for prediction.</p>
<p>We’ll try the first approach here, using a random survival forest to predict survival time using both the spatial, expression, and combined features.</p>
<div class="sourceCode" id="cb41"><html><body><pre class="r"><span class="no">combined_x</span> <span class="kw">&lt;-</span> <span class="no">spatial_comp</span> <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(-<span class="no">SampleID</span>, -<span class="no">TIL_score</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_at</a></span>(<span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html">vars</a></span>(<span class="fu"><a href="https://dplyr.tidyverse.org/reference/reexports.html">matches</a></span>(<span class="st">"[0-9]+"</span>)), <span class="no">sqrt</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span>()

<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"survival"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"glmnet"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"randomForestSRC"</span>)
<span class="no">keep_ix</span> <span class="kw">&lt;-</span> !<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">spatial_samp</span>$<span class="no">Survival_days_capped_2016.1.1</span>)
<span class="no">y</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span>(<span class="no">spatial_samp</span>$<span class="no">Survival_days_capped_2016.1.1</span>[<span class="no">keep_ix</span>], <span class="no">spatial_samp</span>$<span class="no">Censored</span>[<span class="no">keep_ix</span>])

<span class="no">surv_glmnet</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/glmnet/man/cv.glmnet.html">cv.glmnet</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span>(<span class="no">combined_x</span>[<span class="no">keep_ix</span>, ]), <span class="no">y</span>, <span class="kw">family</span> <span class="kw">=</span> <span class="st">"cox"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">surv_glmnet</span>)</pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-16-1.png" width="700"></p>
<div class="sourceCode" id="cb42"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">surv_glmnet</span>$<span class="no">glmnet.fit</span>)</pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-16-2.png" width="700"></p>
<div class="sourceCode" id="cb43"><html><body><pre class="r"><span class="no">surv_rf</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/randomForestSRC/man/rfsrc.html">rfsrc</a></span>(<span class="no">y</span> ~ <span class="no">.</span> , <span class="kw">data</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="no">combined_x</span>[<span class="no">keep_ix</span>, ], <span class="kw">y</span> <span class="kw">=</span> <span class="no">y</span>), <span class="kw">mtry</span><span class="kw">=</span><span class="fl">20</span>)
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">surv_rf</span>) <span class="co"># this model is hopeless</span></pre></body></html></div>
<p><img src="composition_files/figure-html/unnamed-chunk-16-3.png" width="700"></p>
<p>It doesn’t seem like survival is so easy to predict, using this information. This prevents meaningful comparisons between the two feature sets – they are both equally incapable of predicting the response.</p>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p><a href="mailto:ksankaran@wisc.edu" class="email">ksankaran@wisc.edu</a><a href="#fnref1" class="footnote-back">↩︎</a></p></li>
<li id="fn2"><p>Viewed differently, though, the cells within samples are not i.i.d., so the reduction may not be so dramatic.<a href="#fnref2" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Kris Sankaran.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
